import{R as Ne,j as e,au as re,T as p,i as M,av as Pe,_ as ke,r as f,I as y,h as k,b as S,aw as ze,ax as Fe,ay as $e,ad as Ce,az as _e,f as B,aA as he,M as O,S as oe,l as $,o as Ie,p as De,w as A,aB as _,ai as le,aC as W,a7 as fe,a8 as pe,a9 as Re,aD as Te,aE as G,aF as D,aG as Ve,aH as Le,aI as Ee,aJ as Be,t as J,E as U,aK as xe,v as Oe,aL as V,aM as K,aN as Me,aO as Y,aP as Ae,aQ as Ue,B as He,aR as qe}from"./index-hfxJ9ND0.js";import{u as H}from"./useQuery--Ee6qBmG.js";import{c as Ke,u as Qe,g as We,P as Ge}from"./paginated-table-B6jlOu_g.js";import{P as Je,a as ce,b as Ye}from"./side-panel-provider-DzwNjgZ0.js";import{u as Xe}from"./use-breakpoint-BC9zyf7A.js";import{u as Ze,a as X}from"./use-side-panel-BwGqbUJD.js";import{T as et,M as tt}from"./main-BHTg64jE.js";import{F as st}from"./filters-BCekZ7C7.js";import{$ as it}from"./pagination-DmVTMMJU.js";import{A as Z}from"./alert-CiGfdPyF.js";import{$ as at,a as nt,b as rt,c as ot,e as R,d as lt}from"./Table-WVLjXGgi.js";import{b as ct}from"./breadcrumbs-for-path-2XV9zkte.js";import"./useBaseQuery-CSwYJmhT.js";import"./empty-list-DT5Cphlr.js";function dt({text:t,altText:s,onUnselect:a,children:i}){const n=Ne.Children.count(i)>0;return e.jsxs(it,{"aria-label":"Selection controls",className:"bg-foreground-black m-4 flex w-fit items-center rounded-lg shadow-lg drop-shadow-lg",children:[e.jsxs(re,{"aria-label":"Items selected",className:"flex flex-col px-4 py-2 text-center",children:[e.jsxs("div",{className:"flex items-baseline gap-1 whitespace-nowrap",children:[e.jsx(p,{className:"text-on-brand",weight:"medium",size:"sm",children:t}),s&&e.jsx(p,{className:"text-on-brand",size:"xs",children:s})]}),e.jsx(p,{as:r=>e.jsx(M,{onPress:a,...r}),size:"xs",className:"text-tertiary cursor-pointer underline",children:"Unselect all"})]}),n&&e.jsxs(e.Fragment,{children:[e.jsx(Pe,{orientation:"vertical",className:"bg-border-primary w-[1px] shrink-0 self-stretch"}),e.jsx(re,{"aria-label":"Actions",className:"flex gap-2 p-2",children:i})]})]})}function ut(t,s){if(t===void 0)return{shouldBlockFn:()=>!0,withResolver:!1};if("shouldBlockFn"in t)return t;if(typeof t=="function")return{shouldBlockFn:async()=>await t(),enableBeforeUnload:!0,withResolver:!1};const a=!!(t.condition??!0),i=t.blockerFn;return{shouldBlockFn:async()=>a&&i!==void 0?await i():a,enableBeforeUnload:a,withResolver:i===void 0}}function mt(t,s){const{shouldBlockFn:a,enableBeforeUnload:i=!0,disabled:n=!1,withResolver:r=!1}=ut(t),o=ke(),{history:c}=o,[h,l]=f.useState({status:"idle",current:void 0,next:void 0,action:void 0,proceed:void 0,reset:void 0});return f.useEffect(()=>{const m=async u=>{function x(w){const P=o.parseLocation(w),I=o.getMatchedRoutes(P.pathname,void 0);if(I.foundRoute===void 0)throw new Error(`No route found for location ${w.href}`);return{routeId:I.foundRoute.id,fullPath:I.foundRoute.fullPath,pathname:P.pathname,params:I.routeParams,search:P.search}}const j=x(u.currentLocation),g=x(u.nextLocation),z=await a({action:u.action,current:j,next:g});if(!r)return z;if(!z)return!1;const q=await new Promise(w=>{l({status:"blocked",current:j,next:g,action:u.action,proceed:()=>w(!1),reset:()=>w(!0)})});return l({status:"idle",current:void 0,next:void 0,action:void 0,proceed:void 0,reset:void 0}),q};return n?void 0:c.block({blockerFn:m,enableBeforeUnload:i})},[a,i,n,r,c,o]),h}function ge({contentType:t,size:s="lg"}){return t?.startsWith("image")?e.jsx(y,{type:"md-image",size:s}):t==="application/pdf"?e.jsx(y,{type:"md-picture-as-pdf",size:s}):t?.startsWith("video")?e.jsx(y,{type:"md-video-file",size:s}):t?.startsWith("audio")?e.jsx(y,{type:"md-audio-file",size:s}):t==="application/zip"?e.jsx(y,{type:"md-folder-zip",size:s}):e.jsx(y,{type:"md-file-copy",size:s})}function ht(t){return t.isSetuid()?"bg-red-500/80 text-white ring-red-500/80":t.isSetgid()?"bg-orange-500/80 text-white ring-orange-500/80":t.isSticky()?"bg-cyan-500/80 text-white ring-cyan-500/80":"text-primary"}function ee({mode:t,size:s="sm"}){const a=`${(t.Value&511).toString(8)}`,i=[t.isSetuid()&&"SETUID",t.isSetgid()&&"SETGID",t.isSticky()&&"STICKY"].filter(n=>n).join(" | ");return e.jsx(k,{label:`${a} ${i}`,children:e.jsx("button",{children:e.jsx(p,{as:"span",variant:"body",size:s,weight:"medium",monospace:!0,className:S("rounded-xs whitespace-nowrap",ht(t)),children:t.toString()})})})}function ft(t){return typeof t=="function"}function de(t,...s){return ft(t)?t(...s):t}function pt(t){return t||(typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():"")}class xt extends ze{constructor(s){super({pluginId:"pacer",debug:s?.debug})}}const gt=(t,s)=>{be.emit(t,s)},be=new xt;function ue(){return{canLeadingExecute:!0,executionCount:0,isPending:!1,lastArgs:void 0,status:"idle",maybeExecuteCount:0}}const bt={enabled:!0,leading:!1,trailing:!0,wait:0};class jt{constructor(s,a){this.fn=s,this.store=new Fe(ue()),this.setOptions=i=>{this.options={...this.options,...i},this.#s()||this.cancel()},this.#e=i=>{this.store.setState(n=>{const r={...n,...i},{isPending:o}=r;return{...r,status:this.#s()?o?"pending":"idle":"disabled"}}),gt("Debouncer",this)},this.#s=()=>!!de(this.options.enabled,this),this.#n=()=>de(this.options.wait,this),this.maybeExecute=(...i)=>{if(!this.#s())return;this.#e({maybeExecuteCount:this.store.state.maybeExecuteCount+1});let n=!1;this.options.leading&&this.store.state.canLeadingExecute&&(this.#e({canLeadingExecute:!1}),n=!0,this.#i(...i)),this.options.trailing&&this.#e({isPending:!0,lastArgs:i}),this.#t&&clearTimeout(this.#t),this.#t=setTimeout(()=>{this.#e({canLeadingExecute:!0}),this.options.trailing&&!n&&this.#i(...i)},this.#n())},this.#i=(...i)=>{this.#s()&&(this.fn(...i),this.#e({executionCount:this.store.state.executionCount+1,isPending:!1,lastArgs:void 0}),this.options.onExecute?.(i,this))},this.flush=()=>{this.store.state.isPending&&this.store.state.lastArgs&&(this.#a(),this.#i(...this.store.state.lastArgs))},this.#a=()=>{this.#t&&(clearTimeout(this.#t),this.#t=void 0)},this.cancel=()=>{this.#a(),this.#e({canLeadingExecute:!0,isPending:!1})},this.reset=()=>{this.#e(ue())},this.key=pt(a.key),this.options={...bt,...a},this.#e(this.options.initialState??{}),be.on("d-Debouncer",i=>{i.payload.key===this.key&&(this.#e(i.payload.store.state),this.setOptions(i.payload.options))})}#t;#e;#s;#n;#i;#a}function wt(t,s,a=()=>({})){const[i]=f.useState(()=>new jt(t,s)),n=$e(i.store,a);return i.fn=t,i.setOptions(s),f.useEffect(()=>()=>{i.cancel()},[i]),f.useMemo(()=>({...i,state:n}),[i,n])}function yt({search:t,searchPlaceholder:s,filters:a,onSearch:i}){const[n,r]=f.useState(t);f.useEffect(()=>{r(t)},[t]);const o=wt(l=>i(l),{wait:300}),c=l=>{const m=l?String(l):"";r(m),o.maybeExecute(m)},h=()=>{r(""),o.cancel(),i("")};return e.jsxs("div",{className:"flex w-full flex-wrap items-center gap-2 md:flex-nowrap",children:[e.jsx("div",{className:"order-1 flex-1",children:e.jsx(Ce,{icon:"magnifying-glass",placeholder:s,className:"w-full sm:max-w-64 sm:flex-1",value:n,onChange:c,"aria-label":"Search by name",suffix:n?e.jsx(_e,{icon:"close","aria-label":"Clear text",onPress:h,className:"-mr-2"}):void 0})}),a]})}function vt(t){const s=["k","M","B"],a=[1e3,1e6,1e9];let i=`${t}`;for(let n=a.length-1;n>=0;n--){const r=a[n];if(t>=r){i=`${(t/r).toFixed(1).replace(/\.0$/,"")}${s[n]}`;break}}return{Value:t,Pretty:i,toJSON(){return t}}}function St({keys:t,action:s}){f.useEffect(()=>{const a=i=>{const n=i.target,r=n.tagName.toLowerCase();r==="input"||r==="textarea"||r==="select"||n.isContentEditable||t.includes(i.key)&&(i.preventDefault(),i.stopPropagation(),s(i.key))};return window.addEventListener("keydown",a),()=>{window.removeEventListener("keydown",a)}},[t,s])}function Nt(t){const[a,i]=f.useState(t);return f.useEffect(()=>{if(t){i(!1);return}const n=setTimeout(()=>{i(!0)},100);return()=>clearTimeout(n)},[t,100]),a}function Pt({controls:t=[],main:s,sidebar:a,onCollapse:i}){const{position:n,moveSidebar:r}=Ze(),o=f.useRef(null),c=()=>{const g=o.current;g&&(g.isCollapsed()?g.expand():i?i():g.collapse())},[h,l]=f.useState(!1),{isMdDown:m}=Xe(),u=m?"vertical":n,x=u==="horizontal"?20:3,j=u==="horizontal"?30:10;return e.jsx("div",{className:"h-full",children:e.jsxs(Je,{autoSaveId:"sidebar",direction:u,children:[e.jsx(ce,{id:"main",order:1,minSize:j,className:"relative",children:e.jsx("div",{className:"h-full overflow-auto",children:s})}),a&&e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:S("border-primary relative flex items-center justify-center",u==="horizontal"?"border-l-1":"border-t-1"),children:e.jsx("div",{className:"absolute inset-0 -m-2"})}),e.jsx(ce,{id:"sidebar",order:2,defaultSize:50,minSize:x,className:"bg-primary min-h-[50px] min-w-[58px] flex-shrink-0 overflow-hidden md:pt-4",collapsible:!0,collapsedSize:x,ref:o,onCollapse:()=>l(!0),onExpand:()=>l(!1),children:e.jsxs("div",{className:"flex h-full flex-col gap-4",children:[e.jsx("div",{className:"hidden px-4 lg:block",children:e.jsx(kt,{moveSidebar:r,collapseSidebar:c,controls:t,position:u,collapsed:h})}),e.jsx("div",{className:"flex min-h-0 flex-1 flex-col overflow-auto",children:e.jsx("div",{className:"h-full pt-4 md:pt-0",children:a})})]})})]})]})})}function kt({moveSidebar:t,collapseSidebar:s,controls:a,position:i,collapsed:n}){return e.jsxs("div",{className:"text-action-tertiary flex items-center justify-between gap-x-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(B,{tooltip:n?"Expand sidebar":"Collapse sidebar",variant:"tertiary",size:"sm",icon:i==="horizontal"?n?"chevrons-left":"chevrons-right":n?"chevrons-up":"chevrons-down",onPress:s}),a.length>0&&e.jsx("div",{className:"border-primary ml-2 flex gap-2 border-l pl-2",children:a.map(r=>e.jsx(B,{tooltip:r.tooltip,variant:"tertiary",size:"sm",icon:r.icon,isDisabled:r.isDisabled,onPress:r.onPress},r.icon))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(B,{tooltip:"Move the sidebar to the right",variant:"tertiary",size:"sm",icon:"sidebar-right",onPress:()=>t("horizontal"),isDisabled:i==="horizontal"}),e.jsx(B,{tooltip:"Move the sidebar to the bottom",variant:"tertiary",size:"sm",icon:"sidebar-bottom",onPress:()=>t("vertical"),isDisabled:i==="vertical"})]})]})}function je({snapshot:t,vfsEntry:s,variant:a="default",onSnapshotChange:i}){const n=X(he({snapshot:t,vfsEntry:s,page:0,perPage:5}));if(n.error)return e.jsxs(e.Fragment,{children:[e.jsx(p,{size:"md",className:"text-secondary",children:"Unable to load snapshot history"}),e.jsxs(p,{size:"sm",className:"text-secondary",children:["An error occurred while fetching the snapshot history. You can try to reload the page: ",n.error.message]})]});if(n.isPending)return e.jsx(O,{className:S(a==="compact"&&"max-h-[300px] min-w-[320px]"),unstyled:a==="default","aria-label":"Loading timeline",children:Array.from({length:7}).map((l,m)=>e.jsx(O.Item,{leftIcon:"clock",label:e.jsx(oe,{variant:"text",size:"sm",className:"w-[144px]"}),altText:e.jsx(oe,{variant:"text",size:"xs",className:"w-[100px]"}),closeOnSelect:!1,className:S(a==="default"&&"border-primary mb-2 rounded-xl border p-4")},m))});const o=n.data.pages.map(l=>l.response.items).flat().map(l=>me(t,l,s,i,a)),h=n.data.pages[n.data.pages.length-1].response.total-o.length;return h>0&&(h>1&&o.push({id:"more",className:"border-0",label:e.jsxs(p,{variant:"body",size:"sm",className:S("text-tertiary",n.isFetching&&"animate-pulse"),children:[h-1," more snapshot",h-1>1?"s":""]}),alt:e.jsx($,{variant:"secondary",size:a==="compact"?"sm":"md",onPress:()=>n.fetchNextPage(),isDisabled:n.isFetching,isPending:n.isFetching,children:"Load more"}),icon:"circle-plus",closeOnSelect:!1}),n.data.pages[0].lastEntry&&o.push(me(t,n.data.pages[0].lastEntry,s,i,a))),e.jsx(O,{className:S(a==="compact"&&"max-h-[300px] min-w-[320px] overflow-auto"),unstyled:a==="default","aria-label":"Timeline",children:o.map(l=>e.jsx(O.Item,{leftIcon:l.icon,label:l.label,altText:l.alt,onAction:l.onAction,className:S(a==="default"&&"mb-2 rounded-xl border p-4",l.className),closeOnSelect:l.closeOnSelect},l.id))})}const me=function(t,s,a,i,n){const r=a.object?a.object.contentMAC!==s.vfs_entry.object?.contentMAC:a.mac!==s.vfs_entry.mac,o=t.identifier.Value===s.snapshot.identifier.Value,c=o?void 0:()=>{i(s.snapshot.identifier.Value)};return{id:s.snapshot.identifier.Value,label:e.jsxs("div",{className:"group flex items-baseline gap-2",children:[e.jsx(p,{variant:"body",size:"sm",weight:"medium",className:S("text-primary",o&&"underline"),monospace:!0,children:s.snapshot.identifier.toHumanString()}),r&&e.jsx(y,{type:"not-equal",size:"xs"}),!o&&e.jsx(p,{variant:"body",size:n==="compact"?"xs":"sm",className:"text-tertiary",children:r?"Differences":"No changes"})]}),alt:s.snapshot.timestamp.relativeToNow(),icon:"clock",className:o?"border-accent-heavy":"cursor-pointer border-primary",onAction:c}};function zt({snapshot:t,childEntry:s,onSnapshotChange:a}){const{file_info:{mod_time:i,mode:n,uid:r,username:o,gid:c,groupname:h}}=s,l=[{title:"Last modified",description:e.jsx(k,{label:i.Value,children:e.jsx("span",{role:"button",children:i.toHumanString()})}),tooltip:i.Value},{title:"Mode",description:e.jsx(ee,{mode:n})},{title:"Owner user",description:e.jsxs(e.Fragment,{children:[r," ",o]})},{title:"Owner group",description:e.jsxs(e.Fragment,{children:[c," ",h]})},{title:"Version",description:e.jsxs(Ie,{children:[e.jsxs(M,{className:"flex items-center gap-1 font-mono",children:[t.identifier.toHumanString(),e.jsx(y,{type:"caret-down",size:"sm"})]}),e.jsx(De,{offset:4,children:e.jsx(je,{snapshot:t,vfsEntry:s,variant:"compact",onSnapshotChange:a})})]})}];return e.jsx(A,{direction:"row",size:"sm",children:l.map(m=>e.jsx(A.Item,{...m},m.title))})}function Ft(){const{mime:t,filename:s}=_.useSearch(),a=_.useNavigate(),i=f.useCallback(o=>a({search:c=>({...c,page:0,filename:o||void 0})}),[a]),r=[{key:"mime",value:t}].filter(({value:o})=>o);return e.jsx(yt,{search:s,searchPlaceholder:"Search filename: *.txt, tmp_*...",onSearch:i,filters:e.jsxs(e.Fragment,{children:[r.length>0&&e.jsx("div",{className:"order-3 w-full md:order-2 md:w-auto",children:e.jsx(le,{label:"Applied filters",onRemove:o=>{a({search:c=>({...c,mime:o.has("mime")?"":c.mime,page:0})})},children:r.map(({key:o,value:c})=>e.jsx(le.Item,{id:o,value:W.find(({id:h})=>h===t)?.name||c},o))})}),e.jsx("div",{className:"order-2 md:order-3",children:e.jsx(st,{items:[{id:"mime",label:"File type",options:W}],defaultSelected:{mime:t||null},onApply:o=>{a({search:c=>({...c,mime:o.mime||"",page:0})})}})})]})})}const $t=pe({id:Re()}).transform(t=>({url:`${Te}/api/snapshot/vfs/downloader-sign-url/${t.id}?format=tarball`}));async function Ct({snapshotId:t,paths:s}){const a=`/api/snapshot/vfs/downloader/${t}`,i=await fe(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:s.map(r=>({pathname:r}))})});let n;try{n=await i.json()}catch{throw new Error(`the API endpoint ${a} returned HTTP/${i.status} with an invalid JSON payload`)}try{return $t.parse(n)}catch(r){throw new Error(`Failed to parse ${a} response: ${r}`)}}function _t({snapshot:t,childEntries:s,removeSelection:a}){const[i,n]=f.useState(!1),r=s.filter(l=>l.file_info.mode.isDir()).sort((l,m)=>l.file_info.name.localeCompare(m.file_info.name)),o=s.filter(l=>l.file_info.mode.isRegular()).sort((l,m)=>l.file_info.name.localeCompare(m.file_info.name)),c=G(r.reduce((l,m)=>l+(m.summary?.Total.size.Value??0),0)+o.reduce((l,m)=>l+(m.file_info.size.Value??0),0)),h=async()=>{n(!0);const l=await Ct({snapshotId:t.identifier.Value,paths:s.map(u=>u.path)}),m=document.createElement("a");m.style.display="none",m.target="_blank",m.href=l.url,document.body.appendChild(m),m.click(),document.body.removeChild(m),n(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(It,{numberOfItemsSelected:r.length+o.length}),e.jsx(dt,{text:`${s.length} selected`,altText:c.Pretty,onUnselect:a,children:e.jsx($,{variant:"primary",onPress:h,isPending:i,leftIcon:"download",children:"Download"})})]})}function It({numberOfItemsSelected:t}){const{proceed:s,reset:a,status:i}=mt({shouldBlockFn:({current:n,next:r})=>!(t<2||n.pathname===r.pathname),withResolver:!0,enableBeforeUnload:!1});return e.jsx(D,{isDismissable:!0,isOpen:i==="blocked",onOpenChange:()=>a?.(),"aria-label":"Leaving the page?",children:e.jsxs(D.Dialog,{children:[e.jsx(D.Header,{title:"Leaving the page?",description:e.jsxs(e.Fragment,{children:["You have selected ",e.jsx("strong",{children:t})," files and directories."]})}),e.jsx(D.Content,{children:"If you leave this page, your selection will be lost."}),e.jsxs(D.Footer,{className:"flex flex-wrap justify-end gap-2",children:[e.jsx($,{variant:"secondary",onPress:()=>a?.(),children:"Stay here"}),e.jsx($,{variant:"error",onPress:()=>s?.(),children:"Leave the page"})]})]})})}function Dt({snapshot:t,vfsEntry:s}){const a=s.summary?.Total.errors??"several";return e.jsxs(Z,{title:"Unable to backup some files in this directory",variant:"error",actions:e.jsx($,{variant:"secondary",href:{to:"/snapshots/$snapshotId/errors",params:{snapshotId:t.identifier.Value},search:{path:s.path}},children:"View Errors"}),children:["Backup completed with ",e.jsxs("strong",{children:[a," errors"]})," in this directory and its subdirectories."]})}const Rt=pe({total:Ee(),items:Le(Be)});async function Tt({snapshotId:t,path:s,pagination:a}){const i=new URLSearchParams({...Ve(a)}),n=`/api/snapshot/vfs/chunks/${t}:${encodeURIComponent(s)}?${i}`,r=await fe(n);let o;try{o=await r.json()}catch{throw new Error(`the API endpoint ${n} returned HTTP/${r.status} with an invalid JSON payload`)}try{return Rt.parse(o)}catch(c){throw new Error(`Failed to parse ${n} response: ${c}`)}}function Vt({preview:t,snapshot:s}){return e.jsxs("div",{className:"flex w-full flex-col gap-8",children:[e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx(p,{as:"h3",size:"sm",className:"text-primary",weight:"medium",variant:"heading",children:"General information"}),e.jsx(Lt,{fileEntry:t})]}),t.file_info.mode.isRegular()&&e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx(p,{as:"h3",size:"sm",className:"text-primary",weight:"medium",variant:"heading",children:"Advanced"}),e.jsx(Et,{snapshot:s,fileEntry:t})]})]})}function Lt({fileEntry:t}){const{mode:s,mod_time:a,size:i,uid:n,username:r,gid:o,groupname:c}=t.file_info,h=t.object,l=[{show:s.isRegular(),label:"Checksum",content:e.jsx(J,{value:h?.contentMAC??"",size:"sm",weight:"medium"})},{label:"Modified",content:e.jsx(k,{label:a.Value,children:e.jsx("span",{role:"button",children:a.toHumanString()})})},{label:"Size",content:e.jsx(k,{label:`${i.Value.toString()} bytes`,children:e.jsx("span",{role:"button",children:i.Pretty})})},{label:"Mode",content:e.jsx(ee,{mode:s,size:"sm"})},{show:s.isSymlink(),label:"Symlink target",content:t.symlink_target},{show:s.isRegular(),label:"Content Type",content:h?.content_type},{label:"Owner user",content:`${n} ${r}`},{label:"Owner group",content:`${o} ${c}`},{show:s.isRegular(),label:"Entropy",content:h?.entropy.toFixed(2)}];return e.jsx(A,{direction:"col",size:"sm",children:l.filter(m=>m.show!==!1).map(({label:m,content:u})=>e.jsx(A.Item,{title:m,description:u},m))})}function Et({snapshot:t,fileEntry:s}){const a=X({queryKey:["chunks",t.identifier.Value,s.path],initialPageParam:{page:0,perPage:10},queryFn:async({pageParam:r})=>Tt({snapshotId:t.identifier.Value,path:s.path,pagination:{page:r.page,perPage:r.perPage}}),getNextPageParam:(r,o,c)=>{if(r&&!((c.page+1)*c.perPage>=r.total))return{page:c.page+1,perPage:c.perPage}}});if(a.isError)return null;if(a.isPending)return e.jsx(U,{});const i=a.data.pages.flatMap(r=>r.items),n=i.map((r,o)=>{const c=i.slice(0,o).reduce((h,l)=>h+l.length,0);return{...r,offset:c}});return e.jsxs("div",{className:"flex w-full flex-col items-center gap-4",children:[e.jsx("div",{className:"bg-tertiary w-full shrink-0 overflow-x-auto rounded-sm",children:e.jsxs(at,{className:"w-full table-auto border-separate border-spacing-4 text-left","aria-label":"Chunks table",children:[e.jsx(nt,{className:"text-tertiary",children:["Index","Offset","Length","Chunk","Entropy"].map(r=>e.jsx(rt,{isRowHeader:r==="Index",className:r==="Index"?"w-1/9":"w-2/9",children:e.jsx(p,{size:"sm",children:r})},r))}),e.jsx(ot,{className:"text-primary",children:n.map((r,o)=>e.jsxs(p,{size:"sm",weight:"medium",as:c=>e.jsx(lt,{...c},o),children:[e.jsx(R,{children:o}),e.jsx(R,{children:r.offset}),e.jsx(R,{children:r.length}),e.jsx(R,{children:e.jsx(J,{value:r.contentMAC,size:"sm",weight:"medium"})}),e.jsx(R,{children:r.entropy.toFixed(2)})]},o))})]})}),a.hasNextPage&&e.jsx($,{size:"md",variant:"secondary",onPress:()=>a.fetchNextPage(),children:"Load more"})]})}function Bt({snapshot:t,entry:s}){return s.file_info.mode.isRegular()?e.jsx(Ot,{snapshot:t,entry:s}):e.jsx(T,{type:"warning",children:"Cannot preview non-regular files."})}function Ot({snapshot:t,entry:s}){const a=G(10485760),i=G(1024*1024*50),[n,r]=f.useState(s.file_info.size.Value>=a.Value),{data:o,error:c,isPending:h}=H(xe({snapshot:t.identifier.Value,path:s.path}));return h?e.jsx(U,{}):c?e.jsx(T,{type:"error",children:c.message}):e.jsx("div",{className:"flex h-full min-h-0 flex-col gap-4",children:s.file_info.size.Value>=i.Value?e.jsxs(T,{type:"warning",children:["The file is ",s.file_info.size.Pretty,", exceeding the"," ",i.Pretty," display size limit."]}):n?e.jsx(T,{type:"warning",actions:[e.jsx($,{onPress:()=>r(!1),variant:"secondary",children:"Display the file anyway"})],children:e.jsx("div",{className:"flex flex-col gap-4",children:e.jsxs("p",{children:["The file is ",s.file_info.size.Pretty,", which may take a while to load."]})})}):o.type.resolved==="text"||o.type.resolved=="json"?e.jsx(Mt,{snapshot:t,path:s.path,signature:o.signature,entropy:s.object?.entropy,contentType:s.object?.content_type,contentMAC:s.object?.contentMAC}):o.type.resolved==="image"?e.jsx(At,{snapshot:t,path:s.path,signature:o.signature}):o.type.resolved==="pdf"?e.jsx(Ut,{snapshot:t,path:s.path,signature:o.signature}):o.type.resolved==="video"?e.jsx(Ht,{snapshot:t,path:s.path,signature:o.signature}):o.type.resolved==="audio"?e.jsx(qt,{snapshot:t,path:s.path,signature:o.signature}):e.jsxs(T,{type:"warning",children:["Unknown file type: ",o.type.raw]})})}function T({type:t,...s}){return e.jsx("div",{className:"p-4",children:e.jsx(Z,{variant:t==="error"?"error":"warning",title:"Unable to preview file",...s})})}function Mt({snapshot:t,path:s,signature:a,entropy:i,contentType:n,contentMAC:r}){const o=[{id:"highlight",name:"Syntax highlighting"},{id:"plain",name:"Plain text preview"},{id:"rendered",name:"Rendered"}],[c,h]=Oe("filePreviewType","highlight"),[l,m]=f.useState(!1),u=c==="highlight"?"code":c==="plain"?"text_styled":"auto",j=new V(t.identifier.Value,s).getPublicUrl(a,{render:u}),g=N=>{N!==c&&(h(String(N)),m(!1))},z=Nt(l);return e.jsxs("div",{className:"flex min-h-0 flex-1 flex-col",children:[z&&e.jsx(U,{className:"bg-[#282a36]"}),e.jsx("iframe",{src:j,onLoad:()=>m(!0),sandbox:"",className:S("h-full min-h-0 w-full flex-1",z&&"hidden"),style:{colorScheme:"dark",backgroundColor:"black"}}),e.jsxs("div",{className:"border-terminal bg-terminal flex w-full flex-wrap items-center justify-between border-t px-3 py-1",children:[e.jsxs(p,{size:"xs",className:"text-terminal flex flex-1 flex-wrap items-baseline justify-start gap-x-6",children:[e.jsx("span",{children:n}),i&&e.jsxs("span",{className:"hidden md:block",children:["Entropy:"," ",e.jsx(p,{as:"span",size:"sm",weight:"medium",children:i.toFixed(2)})]}),r&&e.jsx(J,{value:r,size:"xs",className:"hidden md:block"})]}),e.jsx(K,{value:c,defaultValue:o[0].id,onChange:g,variant:"terminal",className:"w-46",children:e.jsx(K.ListBox,{children:o.map(N=>e.jsx(K.Item,{...N},N.id))})})]})]})}function At({snapshot:t,path:s,signature:a}){const n=new V(t.identifier.Value,s).getPublicUrl(a);return e.jsx("div",{className:"max-h-full max-w-full object-contain",children:e.jsx("img",{src:n})})}function Ut({snapshot:t,path:s,signature:a}){const n=new V(t.identifier.Value,s).getPublicUrl(a);return e.jsx("embed",{src:n,type:"application/pdf",width:"100%",height:"100%"})}function Ht({snapshot:t,path:s,signature:a}){const n=new V(t.identifier.Value,s).getPublicUrl(a);return e.jsx("video",{controls:!0,width:"100%",children:e.jsx("source",{src:n})})}function qt({snapshot:t,path:s,signature:a}){const n=new V(t.identifier.Value,s).getPublicUrl(a);return e.jsx("audio",{controls:!0,children:e.jsx("source",{src:n})})}function Kt({vfsEntry:t}){const{file_info:s}=t,a=[e.jsx(ee,{mode:s.mode}),e.jsx(k,{label:`${s.size.Value.toString()} bytes`,children:e.jsx("span",{role:"button",children:s.size.Pretty})}),e.jsxs(e.Fragment,{children:[s.uid," ",s.username]}),e.jsxs(e.Fragment,{children:[s.gid," ",s.groupname]}),e.jsx(k,{label:s.mod_time.Value,children:e.jsx("span",{role:"button",children:s.mod_time.toHumanString()})})];return e.jsx("div",{className:"border-accent-heavy ml-4 flex shrink-0 overflow-x-auto border-l-2 pl-2",children:e.jsx("div",{className:"flex gap-4",children:a.map((i,n)=>e.jsx(p,{size:"sm",weight:"medium",className:"text-primary whitespace-nowrap",children:i},n))})})}function Qt({snapshot:t,path:s,onSnapshotChange:a}){const i=H(Me({snapshot:t.identifier.Value,path:s}));return i.isPending?e.jsx(U,{}):i.isError?e.jsx("div",{className:"p-4",children:e.jsx(Z,{variant:"error",title:"Unable to preview file",children:i.error.message})}):e.jsx(Wt,{snapshot:t,vfsEntry:i.data.item,onSnapshotChange:a})}function Wt({snapshot:t,vfsEntry:s,onSnapshotChange:a}){const{data:i,isPending:n,isError:r}=H(xe({snapshot:t.identifier.Value,path:s.path})),o=X(he({snapshot:t,vfsEntry:s,page:0,perPage:5})),c=vt(o.data?.pages[0].response.total||0),h=[{id:"preview",title:"Preview",content:e.jsx(Bt,{snapshot:t,entry:s})},{id:"timeline",title:"Timeline",tag:c.Value?c.Pretty:void 0,content:e.jsx("div",{className:"p-4",children:e.jsx(je,{snapshot:t,vfsEntry:s,onSnapshotChange:a})})},{id:"details",title:"Details",content:e.jsx("div",{className:"p-4",children:e.jsx(Vt,{snapshot:t,preview:s})})}],[l,m]=f.useState(h[0].id),{mode:u}=s.file_info,x=u.isRegular(),j=u.isSymlink();return e.jsxs("div",{className:"flex h-full flex-col gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between px-4",children:[e.jsxs(p,{as:"h2",className:"text-primary flex items-center gap-2",children:[x&&e.jsx(ge,{contentType:s.object?.content_type}),j&&e.jsx(y,{type:"md-link",size:"xl"}),Y.basename(s.path)]}),e.jsx($,{leftIcon:"download",variant:"tertiary",size:"sm",href:i?.downloadUrl,isDisabled:n||!i?.downloadUrl||r,download:!0,children:"Download"})]}),e.jsx("div",{className:"hidden md:block",children:e.jsx(Kt,{vfsEntry:s})}),e.jsx(et,{ariaLabel:"Preview tabs",variant:"underlined",items:h,className:"flex h-full min-h-0 flex-col",selected:l,onSelectionChange:g=>m(String(g))})]})}function Gt({snapshotId:t,scannedDirectory:s,path:a}){return e.jsx(He,{children:ct(t,s,a)})}const Q=Ke();function Jt({snapshot:t,vfsEntry:s,page:a,perPage:i,filters:n,onPageChange:r,onPathChange:o,onSnapshotChange:c,preview:h,onPreviewChange:l}){const m=Object.values(n).some(d=>d),u=H({...Ae({snapshot:t.identifier.Value,vfsEntry:s,page:a,perPage:i,search:m?{contentTypes:n.mime?.contentTypes,filename:n.filename}:void 0}),placeholderData:qe}),x=f.useMemo(()=>[Q.accessor("file_info.name",{header:()=>"Name",cell:({row:{original:d}})=>{const{mode:b,name:F}=d.file_info,v=b.isDir(),C=b.isRegular(),L=b.isSymlink(),E=d.summary?.Total.errors??0,Se=v&&F!==".."&&E>0,ne=Y.relative(s.path,d.parent_path);return e.jsxs("div",{className:"grid grid-cols-[auto_1fr] items-center gap-1",children:[e.jsxs("div",{className:"flex h-6 items-center",children:[v&&e.jsxs(e.Fragment,{children:[Se&&e.jsx(k,{label:`${E} errors in this directory`,offset:4,children:e.jsx(y,{type:"md-error",size:"xl",className:"text-error",role:"button"})}),e.jsx(y,{type:"md-folder",size:"xl"})]}),C&&e.jsx(ge,{contentType:d.object?.content_type}),L&&e.jsx(y,{type:"md-link",size:"xl"})]}),v?e.jsx(p,{variant:"body",size:"sm",className:S("cursor-pointer break-all text-left hover:underline"),as:M,onPress:()=>{v&&o(d.path)},children:F}):e.jsx(p,{variant:"body",size:"sm",className:"break-all",as:"span",children:F}),ne&&u.data?.isSearching&&e.jsx(p,{variant:"body",size:"xs",className:"text-tertiary col-start-2 w-fit cursor-pointer break-all text-left hover:underline",as:M,onPress:()=>{o(d.parent_path)},children:ne})]})}}),Q.display({id:"size",meta:{cellClassName:"md:w-[15%]"},header:()=>"Size",cell:({row:{original:d}})=>{if(d.file_info.name==="..")return;const F=d.file_info.mode.isDir()?d.summary?.Total.size:d.file_info.size,v=F?.Value?.toString()??"0",C=F?.Pretty,L=d.weight.directory,E=L>1?` (${L.toFixed(0)}%)`:"";return e.jsx(k,{label:`${v} bytes`,offset:4,children:e.jsx("span",{className:"inline-block",role:"button",children:e.jsxs(p,{variant:"body",size:"sm",className:"text-secondary w-fit whitespace-nowrap",children:[C,E]})})})}}),Q.accessor("file_info.mod_time",{meta:{cellClassName:"md:w-[20%]"},header:()=>"Modified",cell:d=>{const b=d.getValue();if(!(d.row.original.file_info.name===".."||!b.toHumanString()))return e.jsx(k,{label:b.Value,offset:4,children:e.jsx("span",{className:"inline-block",role:"button",children:e.jsx(p,{variant:"body",size:"sm",className:"text-secondary",children:b.toHumanString()})})})}})],[o,u.data?.isSearching,s.path]),j={pageIndex:a,pageSize:i},[g,z]=f.useState([]),N=g.reduce((d,b)=>(d[b.path]=!0,d),{}),q=Qe({data:u.data?.items??[],rowCount:u.data&&Ue(u.data)?u.data.total:void 0,columns:x,state:{pagination:j,rowSelection:N},enableRowSelection:d=>d.original.file_info.name!=="..",onRowSelectionChange:d=>{const b=typeof d=="function"?d(N):d;z(F=>Object.keys(b).map(v=>F.find(C=>v===C.path)||u.data?.items.find(C=>v===C.path)).filter(v=>v!==void 0))},getRowId:d=>d.path,manualPagination:!0,onPaginationChange:d=>{const b=typeof d=="function"?d(j):d;r(b.pageIndex,b.pageSize)},getCoreRowModel:We()}),w=u.data?.items??[],P=w.findIndex(d=>d.path===h),I=w.slice(P+1),we=P===-1?[]:w.slice(0,P).reverse(),te=I.findIndex(d=>!d.file_info.mode.isDir()),se=we.findIndex(d=>!d.file_info.mode.isDir()),ie=te===-1,ae=se===-1,ye=()=>{if(ie)return;const d=w[P+1+te];d&&l(d.path)},ve=()=>{if(ae)return;const d=w[P-se-1];d&&l(d.path)};return e.jsx(Pt,{main:e.jsx(tt,{title:s.file_info.name,isLoading:u.isFetching,breadcrumb:e.jsx(Gt,{snapshotId:t.identifier,scannedDirectory:t.sources[0].importer.directory,path:s.path}),children:e.jsxs("div",{className:S(g.length>0&&"mb-18"),children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx(zt,{snapshot:t,childEntry:s,onSnapshotChange:c}),s.summary&&s.summary.Total.errors>0&&e.jsx(Dt,{snapshot:t,vfsEntry:s}),e.jsx(Ge,{query:u,table:q,softSelectionState:[w.find(d=>d.path===h)??null,d=>{d&&l(d.path)}],isSoftSelectionEnabledForRow:d=>!d.file_info.mode.isDir(),filters:e.jsx(Ft,{}),ariaLabel:"Snapshot files table",isLoading:u.isFetching})]}),g.length>0&&e.jsx("div",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 -translate-y-1/2",children:e.jsx(_t,{snapshot:t,childEntries:g,removeSelection:()=>z([])})})]})}),sidebar:h&&e.jsx(Qt,{snapshot:t,path:h,onSnapshotChange:c}),controls:[{icon:"chevron-down",tooltip:"Next file",isDisabled:ie,onPress:ye},{icon:"chevron-up",tooltip:"Previous file",isDisabled:ae,onPress:ve}],onCollapse:()=>l(void 0)})}function us(){const t=_.useParams(),s=_.useLoaderDeps(),a=_.useSearch(),i=_.useLoaderData(),n=_.useNavigate(),r=W.find(u=>u.id===a.mime),o=()=>n({to:"/snapshots"}),c=f.useCallback(u=>n({params:{snapshotId:t.snapshotId},search:x=>({...x,path:u,page:0})}),[n,t.snapshotId]),h=f.useCallback((u,x)=>n({search:j=>({...j,page:j.per_page!==x?0:u,per_page:x})}),[n]),l=f.useCallback(u=>{n({params:{snapshotId:u},search:x=>({...x,page:0})})},[n]),m=f.useCallback(u=>{n({params:{snapshotId:t.snapshotId},search:x=>({...x,preview:u}),replace:!0})},[n,t.snapshotId]);return St({keys:["Escape"],action:()=>{const u=Y.dirname(s.path);u===""||u==="/"||u.length<i.getSnapshotResponse.item.sources[0].importer.directory.Value.length?o():c(u+"/")}}),e.jsx(Jt,{snapshot:i.getSnapshotResponse.item,vfsEntry:i.getSnapshotPathResponse.item,page:a.page,perPage:a.per_page,filters:{mime:r,filename:a.filename},onPageChange:h,onPathChange:c,onSnapshotChange:l,preview:a.preview,onPreviewChange:m},t.snapshotId)}export{us as component};
