import{R as _e,j as e,aP as de,T as j,i as W,aQ as $e,ab as Ie,r as g,I as v,h as z,b as P,v as S,aR as ge,M as A,S as ue,l as C,aS as De,aT as me,aU as Re,f as H,aV as Te,aW as be,aX as Ve,aY as Le,t as X,y as q,aZ as Be,Z as G,a_ as Me,a$ as je,o as Oe,p as Ee,b0 as J,x as Ue,b1 as M,b2 as K,aF as he,b3 as ye,b4 as V,b5 as Ae,b6 as He,b7 as Qe,ak as We,b8 as qe,b9 as Q,B as Ge}from"./index-CdIc90l8.js";import{u as Y}from"./useQuery-BzyMkyU9.js";import{u as Ye}from"./use-breakpoint-vkVmt92D.js";import{a as ee,u as Ke}from"./use-side-panel-BrdU6Uh4.js";import{M as Ze,T as Je}from"./icon-badge-CJfylEPM.js";import{c as Xe,u as et,g as tt,P as st}from"./paginated-table-BobOAkaF.js";import{A as te}from"./alert-SgQz-3jM.js";import{$ as it,a as at,b as nt,c as rt,e as L,d as ot}from"./Table-DqT_aCgx.js";import{F as lt}from"./filters-D5JKT-uH.js";import{$ as ct}from"./pagination-DnzyOhfo.js";import{b as dt}from"./breadcrumbs-for-path-oL70y6st.js";import"./useBaseQuery-Cr4gMxig.js";import"./empty-list-DCGZXt7T.js";function ut({text:t,altText:s,onUnselect:a,children:i}){const n=_e.Children.count(i)>0;return e.jsxs(ct,{"aria-label":"Selection controls",className:"bg-foreground-black m-4 flex w-fit items-center rounded-lg shadow-lg drop-shadow-lg",children:[e.jsxs(de,{"aria-label":"Items selected",className:"flex flex-col px-4 py-2 text-center",children:[e.jsxs("div",{className:"flex items-baseline gap-1 whitespace-nowrap",children:[e.jsx(j,{className:"text-on-brand",weight:"medium",size:"sm",children:t}),s&&e.jsx(j,{className:"text-on-brand",size:"xs",children:s})]}),e.jsx(j,{as:r=>e.jsx(W,{onPress:a,...r}),size:"xs",className:"text-tertiary cursor-pointer underline",children:"Unselect all"})]}),n&&e.jsxs(e.Fragment,{children:[e.jsx($e,{orientation:"vertical",className:"bg-border-primary w-[1px] shrink-0 self-stretch"}),e.jsx(de,{"aria-label":"Actions",className:"flex gap-2 p-2",children:i})]})]})}function mt(t,s){if(t===void 0)return{shouldBlockFn:()=>!0,withResolver:!1};if("shouldBlockFn"in t)return t;if(typeof t=="function")return{shouldBlockFn:async()=>await t(),enableBeforeUnload:!0,withResolver:!1};const a=!!(t.condition??!0),i=t.blockerFn;return{shouldBlockFn:async()=>a&&i!==void 0?await i():a,enableBeforeUnload:a,withResolver:i===void 0}}function ht(t,s){const{shouldBlockFn:a,enableBeforeUnload:i=!0,disabled:n=!1,withResolver:r=!1}=mt(t),o=Ie(),{history:u}=o,[d,m]=g.useState({status:"idle",current:void 0,next:void 0,action:void 0,proceed:void 0,reset:void 0});return g.useEffect(()=>{const h=async c=>{function f(b){const R=o.parseLocation(b),_=o.getMatchedRoutes(R.pathname,void 0);if(_.foundRoute===void 0)throw new Error(`No route found for location ${b.href}`);return{routeId:_.foundRoute.id,fullPath:_.foundRoute.fullPath,pathname:R.pathname,params:_.routeParams,search:R.search}}const y=f(c.currentLocation),p=f(c.nextLocation),x=await a({action:c.action,current:y,next:p});if(!r)return x;if(!x)return!1;const I=await new Promise(b=>{m({status:"blocked",current:y,next:p,action:c.action,proceed:()=>b(!1),reset:()=>b(!0)})});return m({status:"idle",current:void 0,next:void 0,action:void 0,proceed:void 0,reset:void 0}),I};return n?void 0:u.block({blockerFn:h,enableBeforeUnload:i})},[a,i,n,r,u,o]),d}function we({contentType:t,size:s="lg"}){return t?.startsWith("image")?e.jsx(v,{type:"md-image",size:s}):t==="application/pdf"?e.jsx(v,{type:"md-picture-as-pdf",size:s}):t?.startsWith("video")?e.jsx(v,{type:"md-video-file",size:s}):t?.startsWith("audio")?e.jsx(v,{type:"md-audio-file",size:s}):t==="application/zip"?e.jsx(v,{type:"md-folder-zip",size:s}):e.jsx(v,{type:"md-file-copy",size:s})}function ft(t){return t.isSetuid()?"bg-red-500/80 text-white ring-red-500/80":t.isSetgid()?"bg-orange-500/80 text-white ring-orange-500/80":t.isSticky()?"bg-cyan-500/80 text-white ring-cyan-500/80":"text-primary"}function se({mode:t,size:s="sm"}){const a=`${(t.Value&511).toString(8)}`,i=[t.isSetuid()&&"SETUID",t.isSetgid()&&"SETGID",t.isSticky()&&"STICKY"].filter(n=>n).join(" | ");return e.jsx(z,{label:`${a} ${i}`,children:e.jsx("button",{children:e.jsx(j,{as:"span",variant:"body",size:s,weight:"medium",monospace:!0,className:P("rounded-xs whitespace-nowrap",ft(t)),children:t.toString()})})})}function pt(t){const s=["k","M","B"],a=[1e3,1e6,1e9];let i=`${t}`;for(let n=a.length-1;n>=0;n--){const r=a[n];if(t>=r){i=`${(t/r).toFixed(1).replace(/\.0$/,"")}${s[n]}`;break}}return{Value:t,Pretty:i,toJSON(){return t}}}function ve({snapshot:t,vfsEntry:s,variant:a="default",onSnapshotChange:i}){const{api:n,repository:r}=S(),o=ee(ge(n,t,s,{repository:r,pagination:{page:0,perPage:5}}));if(o.error)return e.jsxs(e.Fragment,{children:[e.jsx(j,{size:"md",className:"text-secondary",children:"Unable to load snapshot history"}),e.jsxs(j,{size:"sm",className:"text-secondary",children:["An error occurred while fetching the snapshot history. You can try to reload the page: ",o.error.message]})]});if(o.isPending)return e.jsx(A,{className:P(a==="compact"&&"max-h-[300px] min-w-[320px]"),unstyled:a==="default","aria-label":"Loading timeline",children:Array.from({length:7}).map((c,f)=>e.jsx(A.Item,{leftIcon:"clock",label:e.jsx(ue,{variant:"text",size:"sm",className:"w-36"}),altText:e.jsx(ue,{variant:"text",size:"xs",className:"w-[100px]"}),closeOnSelect:!1,className:P(a==="default"&&"border-primary mb-2 rounded-xl border p-4")},f))});const d=o.data.pages.map(c=>c.response.items).flat().map(c=>fe(t,c,s,i,a)),h=o.data.pages[o.data.pages.length-1].response.total-d.length;return h>0&&(h>1&&d.push({id:"more",className:"border-0",label:e.jsxs(j,{variant:"body",size:"sm",className:P("text-tertiary",o.isFetching&&"animate-pulse"),children:[h-1," more snapshot",h-1>1?"s":""]}),alt:e.jsx(C,{variant:"secondary",size:a==="compact"?"sm":"md",onPress:()=>o.fetchNextPage(),isDisabled:o.isFetching,isPending:o.isFetching,children:"Load more"}),icon:"circle-plus",closeOnSelect:!1}),o.data.pages[0].lastEntry&&d.push(fe(t,o.data.pages[0].lastEntry,s,i,a))),e.jsx(A,{className:P(a==="compact"&&"max-h-[300px] min-w-[320px] overflow-auto"),unstyled:a==="default","aria-label":"Timeline",children:d.map(c=>e.jsx(A.Item,{leftIcon:c.icon,label:c.label,altText:c.alt,onAction:c.onAction,className:P(a==="default"&&"mb-2 rounded-xl border p-4",c.className),closeOnSelect:c.closeOnSelect},c.id))})}const fe=function(t,s,a,i,n){const r=a.object?a.object.contentMAC!==s.vfs_entry.object?.contentMAC:a.mac!==s.vfs_entry.mac,o=t.identifier.Value===s.snapshot.identifier.Value,u=o?void 0:()=>{i(s.snapshot.identifier.Value)};return{id:s.snapshot.identifier.Value,label:e.jsxs("div",{className:"group flex items-baseline gap-2",children:[e.jsx(j,{variant:"body",size:"sm",weight:"medium",className:P("text-primary",o&&"underline"),monospace:!0,children:s.snapshot.identifier.toHumanString()}),r&&e.jsx(v,{type:"not-equal",size:"xs"}),!o&&e.jsx(j,{variant:"body",size:n==="compact"?"xs":"sm",className:"text-tertiary",children:r?"Differences":"No changes"})]}),alt:s.snapshot.timestamp.relativeToNow(),icon:"clock",className:o?"border-accent-heavy":"cursor-pointer border-primary",onAction:u}};function xt(t){const[a,i]=g.useState(t);return g.useEffect(()=>{if(t){i(!1);return}const n=setTimeout(()=>{i(!0)},100);return()=>clearTimeout(n)},[t,100]),a}function gt({controls:t=[],main:s,sidebar:a,onCollapse:i}){const{position:n,moveSidebar:r}=Ke(),o=g.useRef(null),u=()=>{const p=o.current;p&&(p.isCollapsed()?p.expand():i?i():p.collapse())},[d,m]=g.useState(!1),{isMdDown:h}=Ye(),c=h?"vertical":n,f=c==="horizontal"?20:3,y=c==="horizontal"?30:10;return e.jsx("div",{className:"h-full",children:e.jsxs(De,{autoSaveId:"sidebar",direction:c,children:[e.jsx(me,{id:"main",order:1,minSize:y,className:"relative",children:e.jsx("div",{className:"h-full overflow-auto",children:s})}),a&&e.jsxs(e.Fragment,{children:[e.jsx(Re,{className:P("border-primary relative flex items-center justify-center",c==="horizontal"?"border-l-1":"border-t-1"),children:e.jsx("div",{className:"absolute inset-0 -m-2"})}),e.jsx(me,{id:"sidebar",order:2,defaultSize:50,minSize:f,className:"bg-primary min-h-[50px] min-w-[58px] flex-shrink-0 overflow-hidden md:pt-4",collapsible:!0,collapsedSize:f,ref:o,onCollapse:()=>m(!0),onExpand:()=>m(!1),children:e.jsxs("div",{className:"flex h-full flex-col gap-4",children:[e.jsx("div",{className:"hidden px-4 lg:block",children:e.jsx(bt,{moveSidebar:r,collapseSidebar:u,controls:t,position:c,collapsed:d})}),e.jsx("div",{className:"flex min-h-0 flex-1 flex-col overflow-auto",children:e.jsx("div",{className:"h-full pt-4 md:pt-0",children:a})})]})})]})]})})}function bt({moveSidebar:t,collapseSidebar:s,controls:a,position:i,collapsed:n}){return e.jsxs("div",{className:"text-action-tertiary flex items-center justify-between gap-x-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(H,{tooltip:n?"Expand sidebar":"Collapse sidebar",variant:"tertiary",size:"sm",icon:i==="horizontal"?n?"chevrons-left":"chevrons-right":n?"chevrons-up":"chevrons-down",onPress:s}),a.length>0&&e.jsx("div",{className:"border-primary ml-2 flex gap-2 border-l pl-2",children:a.map(r=>e.jsx(H,{tooltip:r.tooltip,variant:"tertiary",size:"sm",icon:r.icon,isDisabled:r.isDisabled,onPress:r.onPress},r.icon))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(H,{tooltip:"Move the sidebar to the right",variant:"tertiary",size:"sm",icon:"sidebar-right",onPress:()=>t("horizontal"),isDisabled:i==="horizontal"}),e.jsx(H,{tooltip:"Move the sidebar to the bottom",variant:"tertiary",size:"sm",icon:"sidebar-bottom",onPress:()=>t("vertical"),isDisabled:i==="vertical"})]})]})}const Z=Xe();function jt({snapshot:t,vfsEntry:s,page:a,perPage:i,filters:n,onPageChange:r,onPathChange:o,onSnapshotChange:u,preview:d,onPreviewChange:m,breadcrumb:h,onSearch:c,onRemoveFilter:f,onApplyFilter:y,errorPageHref:p}){const x=Object.values(n).some(l=>l),{api:k,repository:I}=S(),b=Y({...Te(k,{repository:I,snapshot:t.identifier.Value,vfsEntry:s,page:a,perPage:i,search:x?{contentTypes:n.mime?.contentTypes,filename:n.filename}:void 0}),placeholderData:Le}),R=g.useMemo(()=>[Z.accessor("file_info.name",{header:()=>"Name",cell:({row:{original:l}})=>{const{mode:w,name:F}=l.file_info,N=w.isDir(),$=w.isRegular(),E=w.isSymlink(),U=l.summary?.Total.errors??0,Ce=N&&F!==".."&&U>0,ce=be.relative(s.path,l.parent_path);return e.jsxs("div",{className:"grid grid-cols-[auto_1fr] items-center gap-1",children:[e.jsxs("div",{className:"flex h-6 items-center",children:[N&&e.jsxs(e.Fragment,{children:[Ce&&e.jsx(z,{label:`${U} errors in this directory`,offset:4,children:e.jsx(v,{type:"md-error",size:"xl",className:"text-error",role:"button"})}),e.jsx(v,{type:"md-folder",size:"xl"})]}),$&&e.jsx(we,{contentType:l.object?.content_type}),E&&e.jsx(v,{type:"md-link",size:"xl"})]}),N?e.jsx(j,{variant:"body",size:"sm",className:P("cursor-pointer break-all text-left hover:underline"),as:W,onPress:()=>{N&&o(l.path)},children:F}):e.jsx(j,{variant:"body",size:"sm",className:"break-all",as:"span",children:F}),ce&&b.data?.isSearching&&e.jsx(j,{variant:"body",size:"xs",className:"text-tertiary col-start-2 w-fit cursor-pointer break-all text-left hover:underline",as:W,onPress:()=>{o(l.parent_path)},children:ce})]})}}),Z.display({id:"size",meta:{cellClassName:"md:w-[15%]"},header:()=>"Size",cell:({row:{original:l}})=>{if(l.file_info.name==="..")return;const F=l.file_info.mode.isDir()?l.summary?.Total.size:l.file_info.size,N=F?.Value?.toString()??"0",$=F?.Pretty,E=l.weight.directory,U=E>1?` (${E.toFixed(0)}%)`:"";return e.jsx(z,{label:`${N} bytes`,offset:4,children:e.jsx("span",{className:"inline-block",role:"button",children:e.jsxs(j,{variant:"body",size:"sm",className:"text-secondary w-fit whitespace-nowrap",children:[$,U]})})})}}),Z.accessor("file_info.mod_time",{meta:{cellClassName:"md:w-[20%]"},header:()=>"Modified",cell:l=>{const w=l.getValue();if(!(l.row.original.file_info.name===".."||!w.toHumanString()))return e.jsx(z,{label:w.Value,offset:4,children:e.jsx("span",{className:"inline-block",role:"button",children:e.jsx(j,{variant:"body",size:"sm",className:"text-secondary",children:w.toHumanString()})})})}})],[o,b.data?.isSearching,s.path]),_={pageIndex:a,pageSize:i},[O,ie]=g.useState([]),ae=O.reduce((l,w)=>(l[w.path]=!0,l),{}),Ne=et({data:b.data?.items??[],rowCount:b.data&&Ve(b.data)?b.data.total:void 0,columns:R,state:{pagination:_,rowSelection:ae},enableRowSelection:l=>l.original.file_info.name!=="..",onRowSelectionChange:l=>{const w=typeof l=="function"?l(ae):l;ie(F=>Object.keys(w).map(N=>F.find($=>N===$.path)||b.data?.items.find($=>N===$.path)).filter(N=>N!==void 0))},getRowId:l=>l.path,manualPagination:!0,onPaginationChange:l=>{const w=typeof l=="function"?l(_):l;r(w.pageIndex,w.pageSize)},getCoreRowModel:tt()}),D=b.data?.items??[],T=D.findIndex(l=>l.path===d),Pe=D.slice(T+1),ke=T===-1?[]:D.slice(0,T).reverse(),ne=Pe.findIndex(l=>!l.file_info.mode.isDir()),re=ke.findIndex(l=>!l.file_info.mode.isDir()),oe=ne===-1,le=re===-1,ze=()=>{if(oe)return;const l=D[T+1+ne];l&&m(l.path)},Fe=()=>{if(le)return;const l=D[T-re-1];l&&m(l.path)};return e.jsx(gt,{main:e.jsx(Ze,{title:s.file_info.name,isLoading:b.isFetching,breadcrumb:h,children:e.jsxs("div",{className:P(O.length>0&&"mb-18"),children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx(Pt,{snapshot:t,childEntry:s,onSnapshotChange:u}),s.summary&&s.summary.Total.errors>0&&e.jsx(Lt,{href:p,vfsEntry:s}),e.jsx(st,{query:b,table:Ne,softSelectionState:[D.find(l=>l.path===d)??null,l=>{l&&m(l.path)}],isSoftSelectionEnabledForRow:l=>!l.file_info.mode.isDir(),filters:e.jsx(Rt,{mime:n.mime,filename:n.filename,onSearch:c,onRemove:f,onApply:y}),ariaLabel:"Snapshot files table",isLoading:b.isFetching})]}),O.length>0&&e.jsx("div",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 -translate-y-1/2",children:e.jsx(Tt,{snapshot:t,childEntries:O,removeSelection:()=>ie([])})})]})}),sidebar:d&&e.jsx(St,{snapshot:t,path:d,onSnapshotChange:u}),controls:[{icon:"chevron-down",tooltip:"Next file",isDisabled:oe,onPress:ze},{icon:"chevron-up",tooltip:"Previous file",isDisabled:le,onPress:Fe}],onCollapse:()=>m(void 0)})}function yt({preview:t,snapshot:s}){return e.jsxs("div",{className:"flex w-full flex-col gap-8",children:[e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx(j,{as:"h3",size:"sm",className:"text-primary",weight:"medium",variant:"heading",children:"General information"}),e.jsx(wt,{fileEntry:t})]}),t.file_info.mode.isRegular()&&e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx(j,{as:"h3",size:"sm",className:"text-primary",weight:"medium",variant:"heading",children:"Advanced"}),e.jsx(vt,{snapshot:s,fileEntry:t})]})]})}function wt({fileEntry:t}){const{mode:s,mod_time:a,size:i,uid:n,username:r,gid:o,groupname:u}=t.file_info,d=t.object,m=[{show:s.isRegular(),label:"Checksum",content:e.jsx(X,{value:d?.contentMAC??"",size:"sm",weight:"medium"})},{label:"Modified",content:e.jsx(z,{label:a.Value,children:e.jsx("span",{role:"button",children:a.toHumanString()})})},{label:"Size",content:e.jsx(z,{label:`${i.Value.toString()} bytes`,children:e.jsx("span",{role:"button",children:i.Pretty})})},{label:"Mode",content:e.jsx(se,{mode:s,size:"sm"})},{show:s.isSymlink(),label:"Symlink target",content:t.symlink_target},{show:s.isRegular(),label:"Content Type",content:d?.content_type},{label:"Owner user",content:`${n} ${r}`},{label:"Owner group",content:`${o} ${u}`},{show:s.isRegular(),label:"Entropy",content:d?.entropy.toFixed(2)}];return e.jsx(q,{direction:"col",size:"sm",children:m.filter(h=>h.show!==!1).map(({label:h,content:c})=>e.jsx(q.Item,{title:h,description:c},h))})}function vt({snapshot:t,fileEntry:s}){const{api:a,repository:i}=S(),n=ee(Be(a,{repository:i,snapshot:t.identifier.Value,path:s.path}));if(n.isError)return null;if(n.isPending)return e.jsx(G,{});const r=n.data.pages.flatMap(u=>u.items),o=r.map((u,d)=>{const m=r.slice(0,d).reduce((h,c)=>h+c.length,0);return{...u,offset:m}});return e.jsxs("div",{className:"flex w-full flex-col items-center gap-4",children:[e.jsx("div",{className:"bg-tertiary w-full shrink-0 overflow-x-auto rounded-sm",children:e.jsxs(it,{className:"w-full table-auto border-separate border-spacing-4 text-left","aria-label":"Chunks table",children:[e.jsx(at,{className:"text-tertiary",children:["Index","Offset","Length","Chunk","Entropy"].map(u=>e.jsx(nt,{isRowHeader:u==="Index",className:u==="Index"?"w-1/9":"w-2/9",children:e.jsx(j,{size:"sm",children:u})},u))}),e.jsx(rt,{className:"text-primary",children:o.map((u,d)=>e.jsxs(j,{size:"sm",weight:"medium",as:m=>e.jsx(ot,{...m},d),children:[e.jsx(L,{children:d}),e.jsx(L,{children:u.offset}),e.jsx(L,{children:u.length}),e.jsx(L,{children:e.jsx(X,{value:u.contentMAC,size:"sm",weight:"medium"})}),e.jsx(L,{children:u.entropy.toFixed(2)})]},d))})]})}),n.hasNextPage&&e.jsx(C,{size:"md",variant:"secondary",onPress:()=>n.fetchNextPage(),children:"Load more"})]})}function St({snapshot:t,path:s,onSnapshotChange:a}){const{api:i,repository:n}=S(),r=Y(Me(i,{repository:n,snapshot:t.identifier.Value,path:s}));return r.isPending?e.jsx(G,{}):r.isError?e.jsx("div",{className:"p-4",children:e.jsx(te,{variant:"error",title:"Unable to preview file",children:r.error.message})}):e.jsx(Nt,{snapshot:t,vfsEntry:r.data.item,onSnapshotChange:a})}function Nt({snapshot:t,vfsEntry:s,onSnapshotChange:a}){const{api:i,repository:n}=S(),{data:r,isPending:o,isError:u}=Y(je(i,{repository:n,snapshot:t.identifier.Value,path:s.path})),d=ee(ge(i,t,s,{repository:n,pagination:{page:0,perPage:5}})),m=pt(d.data?.pages[0].response.total||0),h=[{id:"preview",title:"Preview",content:e.jsx(zt,{snapshot:t,entry:s})},{id:"timeline",title:"Timeline",tag:m.Value?m.Pretty:void 0,content:e.jsx("div",{className:"p-4",children:e.jsx(ve,{snapshot:t,vfsEntry:s,onSnapshotChange:a})})},{id:"details",title:"Details",content:e.jsx("div",{className:"p-4",children:e.jsx(yt,{snapshot:t,preview:s})})}],[c,f]=g.useState(h[0].id),{mode:y}=s.file_info,p=y.isRegular(),x=y.isSymlink();return e.jsxs("div",{className:"flex h-full flex-col gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between px-4",children:[e.jsxs(j,{as:"h2",className:"text-primary flex items-center gap-2",children:[p&&e.jsx(we,{contentType:s.object?.content_type}),x&&e.jsx(v,{type:"md-link",size:"xl"}),be.basename(s.path)]}),e.jsx(C,{leftIcon:"download",variant:"tertiary",size:"sm",href:r?.downloadUrl,isDisabled:o||!r?.downloadUrl||u,download:!0,children:"Download"})]}),e.jsx("div",{className:"hidden md:block",children:e.jsx(kt,{vfsEntry:s})}),e.jsx(Je,{ariaLabel:"Preview tabs",variant:"underlined",items:h,className:"flex h-full min-h-0 flex-col",selected:c,onSelectionChange:k=>f(String(k))})]})}function Pt({snapshot:t,childEntry:s,onSnapshotChange:a}){const{file_info:{mod_time:i,mode:n,uid:r,username:o,gid:u,groupname:d}}=s,m=[{title:"Last modified",description:e.jsx(z,{label:i.Value,children:e.jsx("span",{role:"button",children:i.toHumanString()})}),tooltip:i.Value},{title:"Mode",description:e.jsx(se,{mode:n})},{title:"Owner user",description:e.jsxs(e.Fragment,{children:[r," ",o]})},{title:"Owner group",description:e.jsxs(e.Fragment,{children:[u," ",d]})},{title:"Version",description:e.jsxs(Oe,{children:[e.jsxs(W,{className:"flex items-center gap-1 font-mono",children:[t.identifier.toHumanString(),e.jsx(v,{type:"caret-down",size:"sm"})]}),e.jsx(Ee,{offset:4,children:e.jsx(ve,{snapshot:t,vfsEntry:s,variant:"compact",onSnapshotChange:a})})]})}];return e.jsx(q,{direction:"row",size:"sm",children:m.map(h=>e.jsx(q.Item,{...h},h.title))})}function kt({vfsEntry:t}){const{file_info:s}=t,a=[e.jsx(se,{mode:s.mode}),e.jsx(z,{label:`${s.size.Value.toString()} bytes`,children:e.jsx("span",{role:"button",children:s.size.Pretty})}),e.jsxs(e.Fragment,{children:[s.uid," ",s.username]}),e.jsxs(e.Fragment,{children:[s.gid," ",s.groupname]}),e.jsx(z,{label:s.mod_time.Value,children:e.jsx("span",{role:"button",children:s.mod_time.toHumanString()})})];return e.jsx("div",{className:"border-accent-heavy ml-4 flex shrink-0 overflow-x-auto border-l-2 pl-2",children:e.jsx("div",{className:"flex gap-4",children:a.map((i,n)=>e.jsx(j,{size:"sm",weight:"medium",className:"text-primary whitespace-nowrap",children:i},n))})})}function zt({snapshot:t,entry:s}){return s.file_info.mode.isRegular()?e.jsx(Ft,{snapshot:t,entry:s}):e.jsx(B,{type:"warning",children:"Cannot preview non-regular files."})}function Ft({snapshot:t,entry:s}){const a=J(10485760),i=J(1024*1024*50),[n,r]=g.useState(s.file_info.size.Value>=a.Value),{api:o,repository:u}=S(),{data:d,error:m,isPending:h}=Y(je(o,{repository:u,snapshot:t.identifier.Value,path:s.path}));return h?e.jsx(G,{}):m?e.jsx(B,{type:"error",children:m.message}):e.jsx("div",{className:"flex h-full min-h-0 flex-col gap-4",children:s.file_info.size.Value>=i.Value?e.jsxs(B,{type:"warning",children:["The file is ",s.file_info.size.Pretty,", exceeding the"," ",i.Pretty," display size limit."]}):n?e.jsx(B,{type:"warning",actions:[e.jsx(C,{onPress:()=>r(!1),variant:"secondary",children:"Display the file anyway"})],children:e.jsx("div",{className:"flex flex-col gap-4",children:e.jsxs("p",{children:["The file is ",s.file_info.size.Pretty,", which may take a while to load."]})})}):d.type.resolved==="text"||d.type.resolved=="json"?e.jsx(Ct,{snapshot:t,path:s.path,signature:d.signature,entropy:s.object?.entropy,contentType:s.object?.content_type,contentMAC:s.object?.contentMAC}):d.type.resolved==="image"?e.jsx(_t,{snapshot:t,path:s.path,signature:d.signature}):d.type.resolved==="pdf"?e.jsx($t,{snapshot:t,path:s.path,signature:d.signature}):d.type.resolved==="video"?e.jsx(It,{snapshot:t,path:s.path,signature:d.signature}):d.type.resolved==="audio"?e.jsx(Dt,{snapshot:t,path:s.path,signature:d.signature}):e.jsxs(B,{type:"warning",children:["Unknown file type: ",d.type.raw]})})}function B({type:t,...s}){return e.jsx("div",{className:"p-4",children:e.jsx(te,{variant:t==="error"?"error":"warning",title:"Unable to preview file",...s})})}function Ct({snapshot:t,path:s,signature:a,entropy:i,contentType:n,contentMAC:r}){const o=[{id:"highlight",name:"Syntax highlighting"},{id:"plain",name:"Plain text preview"},{id:"rendered",name:"Rendered"}],[u,d]=Ue("filePreviewType","highlight"),[m,h]=g.useState(!1),c=u==="highlight"?"code":u==="plain"?"text_styled":"auto",{api:f,repository:y}=S(),x=new M(f,y,t.identifier.Value,s).getPublicUrl(a,{render:c}),k=b=>{b!==u&&(d(String(b)),h(!1))},I=xt(m);return e.jsxs("div",{className:"flex min-h-0 flex-1 flex-col",children:[I&&e.jsx(G,{className:"bg-[#282a36]"}),e.jsx("iframe",{src:x,onLoad:()=>h(!0),sandbox:"",className:P("h-full min-h-0 w-full flex-1",I&&"hidden"),style:{colorScheme:"dark",backgroundColor:"black"}}),e.jsxs("div",{className:"border-terminal bg-terminal flex w-full flex-wrap items-center justify-between border-t px-3 py-1",children:[e.jsxs(j,{size:"xs",className:"text-terminal flex flex-1 flex-wrap items-baseline justify-start gap-x-6",children:[e.jsx("span",{children:n}),i&&e.jsxs("span",{className:"hidden md:block",children:["Entropy:"," ",e.jsx(j,{as:"span",size:"sm",weight:"medium",children:i.toFixed(2)})]}),r&&e.jsx(X,{value:r,size:"xs",className:"hidden md:block"})]}),e.jsx(K,{value:u,defaultValue:o[0].id,onChange:k,variant:"terminal",className:"w-46",children:e.jsx(K.ListBox,{children:o.map(b=>e.jsx(K.Item,{...b},b.id))})})]})]})}function _t({snapshot:t,path:s,signature:a}){const{api:i,repository:n}=S(),o=new M(i,n,t.identifier.Value,s).getPublicUrl(a);return e.jsx("div",{className:"max-h-full max-w-full object-contain",children:e.jsx("img",{src:o})})}function $t({snapshot:t,path:s,signature:a}){const{api:i,repository:n}=S(),o=new M(i,n,t.identifier.Value,s).getPublicUrl(a);return e.jsx("embed",{src:o,type:"application/pdf",width:"100%",height:"100%"})}function It({snapshot:t,path:s,signature:a}){const{api:i,repository:n}=S(),o=new M(i,n,t.identifier.Value,s).getPublicUrl(a);return e.jsx("video",{controls:!0,width:"100%",children:e.jsx("source",{src:o})})}function Dt({snapshot:t,path:s,signature:a}){const{api:i,repository:n}=S(),o=new M(i,n,t.identifier.Value,s).getPublicUrl(a);return e.jsx("audio",{controls:!0,children:e.jsx("source",{src:o})})}function Rt({mime:t,filename:s,onSearch:a,onRemove:i,onApply:n}){return e.jsx(Qt,{search:s,searchPlaceholder:"Search filename: *.txt, tmp_*...",onSearch:a,filters:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"order-3 w-full md:order-2 md:w-auto",children:t&&e.jsx(he,{label:"Applied filters",onRemove:i,children:e.jsx(he.Item,{id:"mime",value:t.name||t.id})})}),e.jsx("div",{className:"order-2 md:order-3",children:e.jsx(lt,{items:[{id:"mime",label:"File type",options:ye}],defaultSelected:{mime:t?t.id:null},onApply:n})})]})})}function Tt({snapshot:t,childEntries:s,removeSelection:a}){const[i,n]=g.useState(!1),r=s.filter(c=>c.file_info.mode.isDir()).sort((c,f)=>c.file_info.name.localeCompare(f.file_info.name)),o=s.filter(c=>c.file_info.mode.isRegular()).sort((c,f)=>c.file_info.name.localeCompare(f.file_info.name)),u=J(r.reduce((c,f)=>c+(f.summary?.Total.size.Value??0),0)+o.reduce((c,f)=>c+(f.file_info.size.Value??0),0)),{api:d,repository:m}=S(),h=async()=>{n(!0);const c=await d.downloadSnapshotVFS({repository:m,snapshot:t.identifier.Value,paths:s.map(y=>y.path)}),f=document.createElement("a");f.style.display="none",f.target="_blank",f.href=c.url,document.body.appendChild(f),f.click(),document.body.removeChild(f),n(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(Vt,{numberOfItemsSelected:r.length+o.length}),e.jsx(ut,{text:`${s.length} selected`,altText:u.Pretty,onUnselect:a,children:e.jsx(C,{variant:"primary",onPress:h,isPending:i,leftIcon:"download",children:"Download"})})]})}function Vt({numberOfItemsSelected:t}){const{proceed:s,reset:a,status:i}=ht({shouldBlockFn:({current:n,next:r})=>!(t<2||n.pathname===r.pathname),withResolver:!0,enableBeforeUnload:!1});return e.jsx(V,{isDismissable:!0,isOpen:i==="blocked",onOpenChange:()=>a?.(),"aria-label":"Leaving the page?",children:e.jsxs(V.Dialog,{children:[e.jsx(V.Header,{title:"Leaving the page?",description:e.jsxs(e.Fragment,{children:["You have selected ",e.jsx("strong",{children:t})," files and directories."]})}),e.jsx(V.Content,{children:"If you leave this page, your selection will be lost."}),e.jsxs(V.Footer,{className:"flex flex-wrap justify-end gap-2",children:[e.jsx(C,{variant:"secondary",onPress:()=>a?.(),children:"Stay here"}),e.jsx(C,{variant:"error",onPress:()=>s?.(),children:"Leave the page"})]})]})})}function Lt({vfsEntry:t,href:s}){const a=t.summary?.Total.errors??"several";return e.jsxs(te,{title:"Unable to backup some files in this directory",variant:"error",actions:e.jsx(C,{variant:"secondary",href:s,children:"View Errors"}),children:["Backup completed with ",e.jsxs("strong",{children:[a," errors"]})," in this directory and its subdirectories."]})}function Bt(t){return typeof t=="function"}function pe(t,...s){return Bt(t)?t(...s):t}function Mt(t){return t||(typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():"")}class Ot extends Ae{constructor(s){super({pluginId:"pacer",debug:s?.debug})}}const Et=(t,s)=>{Se.emit(t,s)},Se=new Ot;function xe(){return{canLeadingExecute:!0,executionCount:0,isPending:!1,lastArgs:void 0,status:"idle",maybeExecuteCount:0}}const Ut={enabled:!0,leading:!1,trailing:!0,wait:0};class At{constructor(s,a){this.fn=s,this.store=new He(xe()),this.setOptions=i=>{this.options={...this.options,...i},this.#s()||this.cancel()},this.#e=i=>{this.store.setState(n=>{const r={...n,...i},{isPending:o}=r;return{...r,status:this.#s()?o?"pending":"idle":"disabled"}}),Et("Debouncer",this)},this.#s=()=>!!pe(this.options.enabled,this),this.#n=()=>pe(this.options.wait,this),this.maybeExecute=(...i)=>{if(!this.#s())return;this.#e({maybeExecuteCount:this.store.state.maybeExecuteCount+1});let n=!1;this.options.leading&&this.store.state.canLeadingExecute&&(this.#e({canLeadingExecute:!1}),n=!0,this.#i(...i)),this.options.trailing&&this.#e({isPending:!0,lastArgs:i}),this.#t&&clearTimeout(this.#t),this.#t=setTimeout(()=>{this.#e({canLeadingExecute:!0}),this.options.trailing&&!n&&this.#i(...i)},this.#n())},this.#i=(...i)=>{this.#s()&&(this.fn(...i),this.#e({executionCount:this.store.state.executionCount+1,isPending:!1,lastArgs:void 0}),this.options.onExecute?.(i,this))},this.flush=()=>{this.store.state.isPending&&this.store.state.lastArgs&&(this.#a(),this.#i(...this.store.state.lastArgs))},this.#a=()=>{this.#t&&(clearTimeout(this.#t),this.#t=void 0)},this.cancel=()=>{this.#a(),this.#e({canLeadingExecute:!0,isPending:!1})},this.reset=()=>{this.#e(xe())},this.key=Mt(a.key),this.options={...Ut,...a},this.#e(this.options.initialState??{}),Se.on("d-Debouncer",i=>{i.payload.key===this.key&&(this.#e(i.payload.store.state),this.setOptions(i.payload.options))})}#t;#e;#s;#n;#i;#a}function Ht(t,s,a=()=>({})){const[i]=g.useState(()=>new At(t,s)),n=Qe(i.store,a);return i.fn=t,i.setOptions(s),g.useEffect(()=>()=>{i.cancel()},[i]),g.useMemo(()=>({...i,state:n}),[i,n])}function Qt({search:t,searchPlaceholder:s,filters:a,onSearch:i}){const[n,r]=g.useState(t);g.useEffect(()=>{r(t)},[t]);const o=Ht(m=>i(m),{wait:300}),u=m=>{const h=m?String(m):"";r(h),o.maybeExecute(h)},d=()=>{r(""),o.cancel(),i("")};return e.jsxs("div",{className:"flex w-full flex-wrap items-center gap-2 md:flex-nowrap",children:[e.jsx("div",{className:"order-1 flex-1",children:e.jsx(We,{icon:"magnifying-glass",placeholder:s,className:"w-full sm:max-w-64 sm:flex-1",value:n,onChange:u,"aria-label":"Search by name",suffix:n?e.jsx(qe,{icon:"close","aria-label":"Clear text",onPress:d,className:"-mr-2"}):void 0})}),a]})}function rs(){const t=Q.useParams(),s=Q.useSearch(),a=Q.useLoaderData(),i=Q.useNavigate(),n=ye.find(p=>p.id===s.mime),r=a.getSnapshotResponse.item,o=a.getSnapshotPathResponse.item,u=g.useCallback(p=>i({params:{snapshotId:t.snapshotId},search:x=>({...x,path:p,page:0})}),[i,t.snapshotId]),d=g.useCallback((p,x)=>i({search:k=>({...k,page:k.per_page!==x?0:p,per_page:x})}),[i]),m=g.useCallback(p=>{i({params:{snapshotId:p},search:x=>({...x,page:0})})},[i]),h=g.useCallback(p=>{i({params:{snapshotId:t.snapshotId},search:x=>({...x,preview:p}),replace:!0})},[i,t.snapshotId]),c=g.useCallback(p=>i({search:x=>({...x,page:0,filename:p||void 0})}),[i]),f=g.useCallback(p=>{i({search:x=>({...x,mime:p.has("mime")?"":x.mime,page:0})})},[i]),y=g.useCallback(p=>{i({search:x=>({...x,mime:p.mime||"",page:0})})},[i]);return e.jsx(jt,{snapshot:r,vfsEntry:o,page:s.page,perPage:s.per_page,filters:{mime:n,filename:s.filename},onPageChange:d,onPathChange:u,onSnapshotChange:m,preview:s.preview,onPreviewChange:h,breadcrumb:e.jsx(Wt,{snapshotId:r.identifier,scannedDirectory:r.sources[0].importer.directory,path:o.path}),onSearch:c,onRemoveFilter:f,onApplyFilter:y,errorPageHref:{to:"/snapshots/$snapshotId/errors",params:{snapshotId:r.identifier.Value},search:{path:o.path}}},t.snapshotId)}function Wt({snapshotId:t,scannedDirectory:s,path:a}){return e.jsx(Ge,{children:dt(t,s,a)})}export{rs as component};
