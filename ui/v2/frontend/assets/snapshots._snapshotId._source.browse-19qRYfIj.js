import{ac as De,r as x,R as Re,j as e,aR as ue,T as b,k as Q,aS as Te,I as w,i as C,d as k,v as S,aT as je,M as A,S as me,m as I,aU as Ve,aV as he,aW as Le,h as H,aX as Ee,aY as ye,aZ as Be,a_ as Me,t as X,y as q,a$ as Oe,Z as G,b0 as Ue,b1 as ve,o as Ae,p as He,b2 as J,x as We,b3 as B,b4 as Y,aH as fe,b5 as we,b6 as V,b7 as Qe,b8 as qe,b9 as Ge,am as Ke,ba as Ye,bb as W,B as pe}from"./index-Aj8lmPfQ.js";import{u as K}from"./useQuery-D2qmIidq.js";import{u as Ze}from"./use-breakpoint-BWT3ojiI.js";import{a as ee,u as Je}from"./use-side-panel-DszmUueS.js";import{M as Xe,T as et}from"./main-Ds-kxHfS.js";import{c as tt,u as st,g as it,P as at}from"./paginated-table-DM9J9R9a.js";import{M as nt,b as rt,a as ot}from"./breadcrumbs-for-path-e4JWC8GD.js";import{A as te}from"./alert-DTC5gTl3.js";import{$ as lt,a as ct,b as dt,c as ut,e as L,d as mt}from"./Table-C77OlBPR.js";import{F as ht}from"./filters-CDn4ay5S.js";import{$ as ft}from"./pagination-Bv4QYb70.js";import"./useBaseQuery-CGDUSr1J.js";import"./empty-list-CA93N3UA.js";function pt(t,s){if(t===void 0)return{shouldBlockFn:()=>!0,withResolver:!1};if("shouldBlockFn"in t)return t;if(typeof t=="function")return{shouldBlockFn:async()=>await t(),enableBeforeUnload:!0,withResolver:!1};const a=!!(t.condition??!0),i=t.blockerFn;return{shouldBlockFn:async()=>a&&i!==void 0?await i():a,enableBeforeUnload:a,withResolver:i===void 0}}function xt(t,s){const{shouldBlockFn:a,enableBeforeUnload:i=!0,disabled:n=!1,withResolver:r=!1}=pt(t),l=De(),{history:o}=l,[f,c]=x.useState({status:"idle",current:void 0,next:void 0,action:void 0,proceed:void 0,reset:void 0});return x.useEffect(()=>{const h=async u=>{function m(z){const N=l.parseLocation(z),y=l.getMatchedRoutes(N.pathname,void 0);if(y.foundRoute===void 0)throw new Error(`No route found for location ${z.href}`);return{routeId:y.foundRoute.id,fullPath:y.foundRoute.fullPath,pathname:N.pathname,params:y.routeParams,search:N.search}}const j=m(u.currentLocation),p=m(u.nextLocation),g=await a({action:u.action,current:j,next:p});if(!r)return g;if(!g)return!1;const _=await new Promise(z=>{c({status:"blocked",current:j,next:p,action:u.action,proceed:()=>z(!1),reset:()=>z(!0)})});return c({status:"idle",current:void 0,next:void 0,action:void 0,proceed:void 0,reset:void 0}),_};return n?void 0:o.block({blockerFn:h,enableBeforeUnload:i})},[a,i,n,r,o,l]),f}function gt(t){const[a,i]=x.useState(t);return x.useEffect(()=>{if(t){i(!1);return}const n=setTimeout(()=>{i(!0)},100);return()=>clearTimeout(n)},[t,100]),a}function bt({text:t,altText:s,onUnselect:a,children:i}){const n=Re.Children.count(i)>0;return e.jsxs(ft,{"aria-label":"Selection controls",className:"bg-foreground-black m-4 flex w-fit items-center rounded-lg shadow-lg drop-shadow-lg",children:[e.jsxs(ue,{"aria-label":"Items selected",className:"flex flex-col px-4 py-2 text-center",children:[e.jsxs("div",{className:"flex items-baseline gap-1 whitespace-nowrap",children:[e.jsx(b,{className:"text-on-brand",weight:"medium",size:"sm",children:t}),s&&e.jsx(b,{className:"text-on-brand",size:"xs",children:s})]}),e.jsx(b,{as:r=>e.jsx(Q,{onPress:a,...r}),size:"xs",className:"text-tertiary cursor-pointer underline",children:"Unselect all"})]}),n&&e.jsxs(e.Fragment,{children:[e.jsx(Te,{orientation:"vertical",className:"bg-border-primary w-[1px] shrink-0 self-stretch"}),e.jsx(ue,{"aria-label":"Actions",className:"flex gap-2 p-2",children:i})]})]})}function Se({contentType:t,size:s="lg"}){return t?.startsWith("image")?e.jsx(w,{type:"md-image",size:s}):t==="application/pdf"?e.jsx(w,{type:"md-picture-as-pdf",size:s}):t?.startsWith("video")?e.jsx(w,{type:"md-video-file",size:s}):t?.startsWith("audio")?e.jsx(w,{type:"md-audio-file",size:s}):t==="application/zip"?e.jsx(w,{type:"md-folder-zip",size:s}):e.jsx(w,{type:"md-file-copy",size:s})}function jt(t){return t.isSetuid()?"bg-red-500/80 text-white ring-red-500/80":t.isSetgid()?"bg-orange-500/80 text-white ring-orange-500/80":t.isSticky()?"bg-cyan-500/80 text-white ring-cyan-500/80":"text-primary"}function se({mode:t,size:s="sm"}){const a=`${(t.Value&511).toString(8)}`,i=[t.isSetuid()&&"SETUID",t.isSetgid()&&"SETGID",t.isSticky()&&"STICKY"].filter(n=>n).join(" | ");return e.jsx(C,{label:`${a} ${i}`,children:e.jsx("button",{children:e.jsx(b,{as:"span",variant:"body",size:s,weight:"medium",monospace:!0,className:k("rounded-xs whitespace-nowrap",jt(t)),children:t.toString()})})})}function yt(t){const s=["k","M","B"],a=[1e3,1e6,1e9];let i=`${t}`;for(let n=a.length-1;n>=0;n--){const r=a[n];if(t>=r){i=`${(t/r).toFixed(1).replace(/\.0$/,"")}${s[n]}`;break}}return{Value:t,Pretty:i,toJSON(){return t}}}function Ne({snapshot:t,source:s,vfsEntry:a,variant:i="default",onSnapshotChange:n}){const{api:r,repository:l}=S(),o=ee(je(r,t,s,a,{repository:l,pagination:{page:0,perPage:5}}));if(o.error)return e.jsxs(e.Fragment,{children:[e.jsx(b,{size:"md",className:"text-secondary",children:"Unable to load snapshot history"}),e.jsxs(b,{size:"sm",className:"text-secondary",children:["An error occurred while fetching the snapshot history. You can try to reload the page: ",o.error.message]})]});if(o.isPending)return e.jsx(A,{className:k(i==="compact"&&"max-h-[300px] min-w-[320px]"),unstyled:i==="default","aria-label":"Loading timeline",children:Array.from({length:7}).map((m,j)=>e.jsx(A.Item,{leftIcon:"clock",label:e.jsx(me,{variant:"text",size:"sm",className:"w-36"}),altText:e.jsx(me,{variant:"text",size:"xs",className:"w-[100px]"}),closeOnSelect:!1,className:k(i==="default"&&"border-primary mb-2 rounded-xl border p-4")},j))});const c=o.data.pages.map(m=>m.response.items).flat().map(m=>xe(t,m,a,n,i)),u=o.data.pages[o.data.pages.length-1].response.total-c.length;return u>0&&(u>1&&c.push({id:"more",className:"border-0",label:e.jsxs(b,{variant:"body",size:"sm",className:k("text-tertiary",o.isFetching&&"animate-pulse"),children:[u-1," more snapshot",u-1>1?"s":""]}),alt:e.jsx(I,{variant:"secondary",size:i==="compact"?"sm":"md",onPress:()=>o.fetchNextPage(),isDisabled:o.isFetching,isPending:o.isFetching,children:"Load more"}),icon:"circle-plus",closeOnSelect:!1}),o.data.pages[0].lastEntry&&c.push(xe(t,o.data.pages[0].lastEntry,a,n,i))),e.jsx(A,{className:k(i==="compact"&&"max-h-[300px] min-w-[320px] overflow-auto"),unstyled:i==="default","aria-label":"Timeline",children:c.map(m=>e.jsx(A.Item,{leftIcon:m.icon,label:m.label,altText:m.alt,onAction:m.onAction,className:k(i==="default"&&"mb-2 rounded-xl border p-4",m.className),closeOnSelect:m.closeOnSelect},m.id))})}const xe=function(t,s,a,i,n){const r=a.object?a.object.contentMAC!==s.vfs_entry.object?.contentMAC:a.mac!==s.vfs_entry.mac,l=t.identifier.Value===s.snapshot.identifier.Value,o=l?void 0:()=>{i(s.snapshot.identifier.Value)};return{id:s.snapshot.identifier.Value,label:e.jsxs("div",{className:"group flex items-baseline gap-2",children:[e.jsx(b,{variant:"body",size:"sm",weight:"medium",className:k("text-primary",l&&"underline"),monospace:!0,children:s.snapshot.identifier.toHumanString()}),r&&e.jsx(w,{type:"not-equal",size:"xs"}),!l&&e.jsx(b,{variant:"body",size:n==="compact"?"xs":"sm",className:"text-tertiary",children:r?"Differences":"No changes"})]}),alt:s.snapshot.timestamp.relativeToNow(),icon:"clock",className:l?"border-accent-heavy":"cursor-pointer border-primary",onAction:o}};function vt({controls:t=[],main:s,sidebar:a,onCollapse:i}){const{position:n,moveSidebar:r}=Je(),l=x.useRef(null),o=()=>{const p=l.current;p&&(p.isCollapsed()?p.expand():i?i():p.collapse())},[f,c]=x.useState(!1),{isMdDown:h}=Ze(),u=h?"vertical":n,m=u==="horizontal"?20:3,j=u==="horizontal"?30:10;return e.jsx("div",{className:"h-full",children:e.jsxs(Ve,{autoSaveId:"sidebar",direction:u,children:[e.jsx(he,{id:"main",order:1,minSize:j,className:"relative",children:e.jsx("div",{className:"h-full overflow-auto",children:s})}),a&&e.jsxs(e.Fragment,{children:[e.jsx(Le,{className:k("border-primary relative flex items-center justify-center",u==="horizontal"?"border-l-1":"border-t-1"),children:e.jsx("div",{className:"absolute inset-0 -m-2"})}),e.jsx(he,{id:"sidebar",order:2,defaultSize:50,minSize:m,className:"bg-primary min-h-[50px] min-w-[58px] flex-shrink-0 overflow-hidden md:pt-4",collapsible:!0,collapsedSize:m,ref:l,onCollapse:()=>c(!0),onExpand:()=>c(!1),children:e.jsxs("div",{className:"flex h-full flex-col gap-4",children:[e.jsx("div",{className:"hidden px-4 lg:block",children:e.jsx(wt,{moveSidebar:r,collapseSidebar:o,controls:t,position:u,collapsed:f})}),e.jsx("div",{className:"flex min-h-0 flex-1 flex-col overflow-auto",children:e.jsx("div",{className:"h-full pt-4 md:pt-0",children:a})})]})})]})]})})}function wt({moveSidebar:t,collapseSidebar:s,controls:a,position:i,collapsed:n}){return e.jsxs("div",{className:"text-action-tertiary flex items-center justify-between gap-x-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(H,{tooltip:n?"Expand sidebar":"Collapse sidebar",variant:"tertiary",size:"sm",icon:i==="horizontal"?n?"chevrons-left":"chevrons-right":n?"chevrons-up":"chevrons-down",onPress:s}),a.length>0&&e.jsx("div",{className:"border-primary ml-2 flex gap-2 border-l pl-2",children:a.map(r=>e.jsx(H,{tooltip:r.tooltip,variant:"tertiary",size:"sm",icon:r.icon,isDisabled:r.isDisabled,onPress:r.onPress},r.icon))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(H,{tooltip:"Move the sidebar to the right",variant:"tertiary",size:"sm",icon:"sidebar-right",onPress:()=>t("horizontal"),isDisabled:i==="horizontal"}),e.jsx(H,{tooltip:"Move the sidebar to the bottom",variant:"tertiary",size:"sm",icon:"sidebar-bottom",onPress:()=>t("vertical"),isDisabled:i==="vertical"})]})]})}const Z=tt();function St({snapshot:t,source:s,vfsEntry:a,page:i,perPage:n,filters:r,onPageChange:l,onPathChange:o,onSnapshotChange:f,preview:c,onPreviewChange:h,breadcrumb:u,fileBreadcrumb:m,onSearch:j,onRemoveFilter:p,onApplyFilter:g,errorPageHref:F}){const _=Object.values(r).some(d=>d),{api:z,repository:N}=S(),y=K({...Ee(z,{repository:N,snapshot:t.identifier.Value,source:s,vfsEntry:a,page:i,perPage:n,search:_?{contentTypes:r.mime?.contentTypes,filename:r.filename}:void 0}),placeholderData:Me}),ke=x.useMemo(()=>[Z.accessor("file_info.name",{header:()=>"Name",cell:({row:{original:d}})=>{const{mode:v,name:$}=d.file_info,P=v.isDir(),D=v.isRegular(),O=v.isSymlink(),U=d.summary?.Total.errors??0,_e=P&&$!==".."&&U>0,de=ye.relative(a.path,d.parent_path);return e.jsxs("div",{className:"grid grid-cols-[auto_1fr] items-center gap-1",children:[e.jsxs("div",{className:"flex h-6 items-center",children:[P&&e.jsxs(e.Fragment,{children:[_e&&e.jsx(C,{label:`${U} errors in this directory`,offset:4,children:e.jsx(w,{type:"md-error",size:"xl",className:"text-error",role:"button"})}),e.jsx(w,{type:"md-folder",size:"xl"})]}),D&&e.jsx(Se,{contentType:d.object?.content_type}),O&&e.jsx(w,{type:"md-link",size:"xl"})]}),P?e.jsx(b,{variant:"body",size:"sm",className:k("cursor-pointer break-all text-left hover:underline"),as:Q,onPress:()=>{P&&o(d.path)},children:$}):e.jsx(b,{variant:"body",size:"sm",className:"break-all",as:"span",children:$}),de&&y.data?.isSearching&&e.jsx(b,{variant:"body",size:"xs",className:"text-tertiary col-start-2 w-fit cursor-pointer break-all text-left hover:underline",as:Q,onPress:()=>{o(d.parent_path)},children:de})]})}}),Z.display({id:"size",meta:{cellClassName:"md:w-[15%]"},header:()=>"Size",cell:({row:{original:d}})=>{if(d.file_info.name==="..")return;const $=d.file_info.mode.isDir()?d.summary?.Total.size:d.file_info.size,P=$?.Value?.toString()??"0",D=$?.Pretty,O=d.weight.directory,U=O>1?` (${O.toFixed(0)}%)`:"";return e.jsx(C,{label:`${P} bytes`,offset:4,children:e.jsx("span",{className:"inline-block",role:"button",children:e.jsxs(b,{variant:"body",size:"sm",className:"text-secondary w-fit whitespace-nowrap",children:[D,U]})})})}}),Z.accessor("file_info.mod_time",{meta:{cellClassName:"md:w-[20%]"},header:()=>"Modified",cell:d=>{const v=d.getValue();if(!(d.row.original.file_info.name===".."||!v.toHumanString()))return e.jsx(C,{label:v.Value,offset:4,children:e.jsx("span",{className:"inline-block",role:"button",children:e.jsx(b,{variant:"body",size:"sm",className:"text-secondary",children:v.toHumanString()})})})}})],[o,y.data?.isSearching,a.path]),ie={pageIndex:i,pageSize:n},[M,ae]=x.useState([]),ne=M.reduce((d,v)=>(d[v.path]=!0,d),{}),ze=st({data:y.data?.items??[],rowCount:y.data&&Be(y.data)?y.data.total:void 0,columns:ke,state:{pagination:ie,rowSelection:ne},enableRowSelection:d=>d.original.file_info.name!=="..",onRowSelectionChange:d=>{const v=typeof d=="function"?d(ne):d;ae($=>Object.keys(v).map(P=>$.find(D=>P===D.path)||y.data?.items.find(D=>P===D.path)).filter(P=>P!==void 0))},getRowId:d=>d.path,manualPagination:!0,onPaginationChange:d=>{const v=typeof d=="function"?d(ie):d;l(v.pageIndex,v.pageSize)},getCoreRowModel:it()}),R=y.data?.items??[],T=R.findIndex(d=>d.path===c),Fe=R.slice(T+1),Ce=T===-1?[]:R.slice(0,T).reverse(),re=Fe.findIndex(d=>!d.file_info.mode.isDir()),oe=Ce.findIndex(d=>!d.file_info.mode.isDir()),le=re===-1,ce=oe===-1,$e=()=>{if(le)return;const d=R[T+1+re];d&&h(d.path)},Ie=()=>{if(ce)return;const d=R[T-oe-1];d&&h(d.path)};return e.jsx(vt,{main:e.jsx(Xe,{title:e.jsx(nt,{snapshot:t,source:s}),isLoading:y.isFetching,breadcrumb:u,children:e.jsxs("div",{className:"flex flex-col gap-4",children:[m,e.jsxs("div",{className:k(M.length>0&&"mb-18"),children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx(Ct,{snapshot:t,source:s,childEntry:a,onSnapshotChange:f}),a.summary&&a.summary.Total.errors>0&&e.jsx(Ot,{href:F,vfsEntry:a}),e.jsx(at,{query:y,table:ze,softSelectionState:[R.find(d=>d.path===c)??null,d=>{d&&h(d.path)}],isSoftSelectionEnabledForRow:d=>!d.file_info.mode.isDir(),filters:e.jsx(Et,{mime:r.mime,filename:r.filename,onSearch:j,onRemove:p,onApply:g}),ariaLabel:"Snapshot files table",isLoading:y.isFetching})]}),M.length>0&&e.jsx("div",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 -translate-y-1/2",children:e.jsx(Bt,{snapshot:t,childEntries:M,removeSelection:()=>ae([])})})]})]})}),sidebar:c&&e.jsx(zt,{snapshot:t,source:s,path:c,onSnapshotChange:f}),controls:[{icon:"chevron-down",tooltip:"Next file",isDisabled:le,onPress:$e},{icon:"chevron-up",tooltip:"Previous file",isDisabled:ce,onPress:Ie}],onCollapse:()=>h(void 0)})}function Nt({preview:t,snapshot:s}){return e.jsxs("div",{className:"flex w-full flex-col gap-8",children:[e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx(b,{as:"h3",size:"sm",className:"text-primary",weight:"medium",variant:"heading",children:"General information"}),e.jsx(Pt,{fileEntry:t})]}),t.file_info.mode.isRegular()&&e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx(b,{as:"h3",size:"sm",className:"text-primary",weight:"medium",variant:"heading",children:"Advanced"}),e.jsx(kt,{snapshot:s,fileEntry:t})]})]})}function Pt({fileEntry:t}){const{mode:s,mod_time:a,size:i,uid:n,username:r,gid:l,groupname:o}=t.file_info,f=t.object,c=[{show:s.isRegular(),label:"Checksum",content:e.jsx(X,{value:f?.contentMAC??"",size:"sm",weight:"medium"})},{label:"Modified",content:e.jsx(C,{label:a.Value,children:e.jsx("span",{role:"button",children:a.toHumanString()})})},{label:"Size",content:e.jsx(C,{label:`${i.Value.toString()} bytes`,children:e.jsx("span",{role:"button",children:i.Pretty})})},{label:"Mode",content:e.jsx(se,{mode:s,size:"sm"})},{show:s.isSymlink(),label:"Symlink target",content:t.symlink_target},{show:s.isRegular(),label:"Content Type",content:f?.content_type},{label:"Owner user",content:`${n} ${r}`},{label:"Owner group",content:`${l} ${o}`},{show:s.isRegular(),label:"Entropy",content:f?.entropy.toFixed(2)}];return e.jsx(q,{direction:"col",size:"sm",children:c.filter(h=>h.show!==!1).map(({label:h,content:u})=>e.jsx(q.Item,{title:h,description:u},h))})}function kt({snapshot:t,fileEntry:s}){const{api:a,repository:i}=S(),n=ee(Oe(a,{repository:i,snapshot:t.identifier.Value,path:s.path}));if(n.isError)return null;if(n.isPending)return e.jsx(G,{});const r=n.data.pages.flatMap(o=>o.items),l=r.map((o,f)=>{const c=r.slice(0,f).reduce((h,u)=>h+u.length,0);return{...o,offset:c}});return e.jsxs("div",{className:"flex w-full flex-col items-center gap-4",children:[e.jsx("div",{className:"bg-tertiary w-full shrink-0 overflow-x-auto rounded-sm",children:e.jsxs(lt,{className:"w-full table-auto border-separate border-spacing-4 text-left","aria-label":"Chunks table",children:[e.jsx(ct,{className:"text-tertiary",children:["Index","Offset","Length","Chunk","Entropy"].map(o=>e.jsx(dt,{isRowHeader:o==="Index",className:o==="Index"?"w-1/9":"w-2/9",children:e.jsx(b,{size:"sm",children:o})},o))}),e.jsx(ut,{className:"text-primary",children:l.map((o,f)=>e.jsxs(b,{size:"sm",weight:"medium",as:c=>e.jsx(mt,{...c},f),children:[e.jsx(L,{children:f}),e.jsx(L,{children:o.offset}),e.jsx(L,{children:o.length}),e.jsx(L,{children:e.jsx(X,{value:o.contentMAC,size:"sm",weight:"medium"})}),e.jsx(L,{children:o.entropy.toFixed(2)})]},f))})]})}),n.hasNextPage&&e.jsx(I,{size:"md",variant:"secondary",onPress:()=>n.fetchNextPage(),children:"Load more"})]})}function zt({snapshot:t,source:s,path:a,onSnapshotChange:i}){const{api:n,repository:r}=S(),l=K(Ue(n,{repository:r,source:s,snapshot:t.identifier.Value,path:a}));return l.isPending?e.jsx(G,{}):l.isError?e.jsx("div",{className:"p-4",children:e.jsx(te,{variant:"error",title:"Unable to preview file",children:l.error.message})}):e.jsx(Ft,{snapshot:t,source:s,vfsEntry:l.data.item,onSnapshotChange:i})}function Ft({snapshot:t,source:s,vfsEntry:a,onSnapshotChange:i}){const{api:n,repository:r}=S(),{data:l,isPending:o,isError:f}=K(ve(n,{repository:r,snapshot:t.identifier.Value,source:s,path:a.path})),c=ee(je(n,t,s,a,{repository:r,pagination:{page:0,perPage:5}})),h=yt(c.data?.pages[0].response.total||0),u=[{id:"preview",title:"Preview",content:e.jsx(It,{snapshot:t,source:s,entry:a})},{id:"timeline",title:"Timeline",tag:h.Value?h.Pretty:void 0,content:e.jsx("div",{className:"p-4",children:e.jsx(Ne,{snapshot:t,source:s,vfsEntry:a,onSnapshotChange:i})})},{id:"details",title:"Details",content:e.jsx("div",{className:"p-4",children:e.jsx(Nt,{snapshot:t,preview:a})})}],[m,j]=x.useState(u[0].id),{mode:p}=a.file_info,g=p.isRegular(),F=p.isSymlink();return e.jsxs("div",{className:"flex h-full flex-col gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between px-4",children:[e.jsxs(b,{as:"h2",className:"text-primary flex items-center gap-2",children:[g&&e.jsx(Se,{contentType:a.object?.content_type}),F&&e.jsx(w,{type:"md-link",size:"xl"}),ye.basename(a.path)]}),e.jsx(I,{leftIcon:"download",variant:"tertiary",size:"sm",href:l?.downloadUrl,isDisabled:o||!l?.downloadUrl||f,download:!0,children:"Download"})]}),e.jsx("div",{className:"hidden md:block",children:e.jsx($t,{vfsEntry:a})}),e.jsx(et,{ariaLabel:"Preview tabs",variant:"underlined",items:u,className:"flex h-full min-h-0 flex-col",selected:m,onSelectionChange:_=>j(String(_))})]})}function Ct({snapshot:t,source:s,childEntry:a,onSnapshotChange:i}){const{file_info:{mod_time:n,mode:r,uid:l,username:o,gid:f,groupname:c}}=a,h=[{title:"Last modified",description:e.jsx(C,{label:n.Value,children:e.jsx("span",{role:"button",children:n.toHumanString()})}),tooltip:n.Value},{title:"Mode",description:e.jsx(se,{mode:r})},{title:"Owner user",description:e.jsxs(e.Fragment,{children:[l," ",o]})},{title:"Owner group",description:e.jsxs(e.Fragment,{children:[f," ",c]})},{title:"Version",description:e.jsxs(Ae,{children:[e.jsxs(Q,{className:"flex items-center gap-1 font-mono",children:[t.identifier.toHumanString(),e.jsx(w,{type:"caret-down",size:"sm"})]}),e.jsx(He,{offset:4,children:e.jsx(Ne,{snapshot:t,source:s,vfsEntry:a,variant:"compact",onSnapshotChange:i})})]})}];return e.jsx(q,{direction:"row",size:"sm",children:h.map(u=>e.jsx(q.Item,{...u},u.title))})}function $t({vfsEntry:t}){const{file_info:s}=t,a=[e.jsx(se,{mode:s.mode}),e.jsx(C,{label:`${s.size.Value.toString()} bytes`,children:e.jsx("span",{role:"button",children:s.size.Pretty})}),e.jsxs(e.Fragment,{children:[s.uid," ",s.username]}),e.jsxs(e.Fragment,{children:[s.gid," ",s.groupname]}),e.jsx(C,{label:s.mod_time.Value,children:e.jsx("span",{role:"button",children:s.mod_time.toHumanString()})})];return e.jsx("div",{className:"border-accent-heavy ml-4 flex shrink-0 overflow-x-auto border-l-2 pl-2",children:e.jsx("div",{className:"flex gap-4",children:a.map((i,n)=>e.jsx(b,{size:"sm",weight:"medium",className:"text-primary whitespace-nowrap",children:i},n))})})}function It({snapshot:t,source:s,entry:a}){return a.file_info.mode.isRegular()?e.jsx(_t,{snapshot:t,source:s,entry:a}):e.jsx(E,{type:"warning",children:"Cannot preview non-regular files."})}function _t({snapshot:t,source:s,entry:a}){const i=J(10485760),n=J(1024*1024*50),[r,l]=x.useState(a.file_info.size.Value>=i.Value),{api:o,repository:f}=S(),{data:c,error:h,isPending:u}=K(ve(o,{repository:f,snapshot:t.identifier.Value,source:s,path:a.path}));return u?e.jsx(G,{}):h?e.jsx(E,{type:"error",children:h.message}):e.jsx("div",{className:"flex h-full min-h-0 flex-col gap-4",children:a.file_info.size.Value>=n.Value?e.jsxs(E,{type:"warning",children:["The file is ",a.file_info.size.Pretty,", exceeding the"," ",n.Pretty," display size limit."]}):r?e.jsx(E,{type:"warning",actions:[e.jsx(I,{onPress:()=>l(!1),variant:"secondary",children:"Display the file anyway"})],children:e.jsx("div",{className:"flex flex-col gap-4",children:e.jsxs("p",{children:["The file is ",a.file_info.size.Pretty,", which may take a while to load."]})})}):c.type.resolved==="text"||c.type.resolved=="json"?e.jsx(Dt,{snapshot:t,source:s,path:a.path,signature:c.signature,entropy:a.object?.entropy,contentType:a.object?.content_type,contentMAC:a.object?.contentMAC}):c.type.resolved==="image"?e.jsx(Rt,{snapshot:t,source:s,path:a.path,signature:c.signature}):c.type.resolved==="pdf"?e.jsx(Tt,{snapshot:t,source:s,path:a.path,signature:c.signature}):c.type.resolved==="video"?e.jsx(Vt,{snapshot:t,source:s,path:a.path,signature:c.signature}):c.type.resolved==="audio"?e.jsx(Lt,{snapshot:t,source:s,path:a.path,signature:c.signature}):e.jsxs(E,{type:"warning",children:["Unknown file type: ",c.type.raw]})})}function E({type:t,...s}){return e.jsx("div",{className:"p-4",children:e.jsx(te,{variant:t==="error"?"error":"warning",title:"Unable to preview file",...s})})}function Dt({snapshot:t,source:s,path:a,signature:i,entropy:n,contentType:r,contentMAC:l}){const o=[{id:"highlight",name:"Syntax highlighting"},{id:"plain",name:"Plain text preview"},{id:"rendered",name:"Rendered"}],[f,c]=We("filePreviewType","highlight"),[h,u]=x.useState(!1),m=f==="highlight"?"code":f==="plain"?"text_styled":"auto",{api:j,repository:p}=S(),F=new B(j,p,t.identifier.Value,s,a).getPublicUrl(i,{render:m}),_=N=>{N!==f&&(c(String(N)),u(!1))},z=gt(h);return e.jsxs("div",{className:"flex min-h-0 flex-1 flex-col",children:[z&&e.jsx(G,{className:"bg-[#282a36]"}),e.jsx("iframe",{src:F,onLoad:()=>u(!0),sandbox:"",className:k("h-full min-h-0 w-full flex-1",z&&"hidden"),style:{colorScheme:"dark",backgroundColor:"black"}}),e.jsxs("div",{className:"border-terminal bg-terminal flex w-full flex-wrap items-center justify-between border-t px-3 py-1",children:[e.jsxs(b,{size:"xs",className:"text-terminal flex flex-1 flex-wrap items-baseline justify-start gap-x-6",children:[e.jsx("span",{children:r}),n&&e.jsxs("span",{className:"hidden md:block",children:["Entropy:"," ",e.jsx(b,{as:"span",size:"sm",weight:"medium",children:n.toFixed(2)})]}),l&&e.jsx(X,{value:l,size:"xs",className:"hidden md:block"})]}),e.jsx(Y,{value:f,defaultValue:o[0].id,onChange:_,variant:"terminal",className:"w-46",children:e.jsx(Y.ListBox,{children:o.map(N=>e.jsx(Y.Item,{...N},N.id))})})]})]})}function Rt({snapshot:t,source:s,path:a,signature:i}){const[n,r]=x.useState(!1),{api:l,repository:o}=S(),c=new B(l,o,t.identifier.Value,s,a).getPublicUrl(i);return x.useEffect(()=>{const h=u=>{u.key==="Escape"&&n&&r(!1)};return document.addEventListener("keydown",h),()=>document.removeEventListener("keydown",h)},[n]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"max-h-full max-w-full object-contain",children:e.jsx("button",{className:"cursor-zoom-in",onClick:()=>r(!0),children:e.jsx("img",{src:c,alt:"Preview"})})}),n&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/90",children:e.jsx("div",{className:"relative h-full w-full",children:e.jsx("img",{src:c,alt:"Fullscreen preview",className:"h-full w-full cursor-zoom-out object-contain",onClick:()=>r(!1)})})})]})}function Tt({snapshot:t,source:s,path:a,signature:i}){const{api:n,repository:r}=S(),o=new B(n,r,t.identifier.Value,s,a).getPublicUrl(i);return e.jsx("embed",{src:o,type:"application/pdf",width:"100%",height:"100%"})}function Vt({snapshot:t,source:s,path:a,signature:i}){const{api:n,repository:r}=S(),o=new B(n,r,t.identifier.Value,s,a).getPublicUrl(i);return e.jsx("video",{controls:!0,width:"100%",children:e.jsx("source",{src:o})})}function Lt({snapshot:t,source:s,path:a,signature:i}){const{api:n,repository:r}=S(),o=new B(n,r,t.identifier.Value,s,a).getPublicUrl(i);return e.jsx("audio",{controls:!0,children:e.jsx("source",{src:o})})}function Et({mime:t,filename:s,onSearch:a,onRemove:i,onApply:n}){return e.jsx(Kt,{search:s,searchPlaceholder:"Search filename: *.txt, tmp_*...",onSearch:a,filters:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"order-3 w-full md:order-2 md:w-auto",children:t&&e.jsx(fe,{label:"Applied filters",onRemove:i,children:e.jsx(fe.Item,{id:"mime",value:t.name||t.id})})}),e.jsx("div",{className:"order-2 md:order-3",children:e.jsx(ht,{items:[{id:"mime",label:"File type",options:we}],defaultSelected:{mime:t?t.id:null},onApply:n})})]})})}function Bt({snapshot:t,childEntries:s,removeSelection:a}){const[i,n]=x.useState(!1),r=s.filter(u=>u.file_info.mode.isDir()).sort((u,m)=>u.file_info.name.localeCompare(m.file_info.name)),l=s.filter(u=>u.file_info.mode.isRegular()).sort((u,m)=>u.file_info.name.localeCompare(m.file_info.name)),o=J(r.reduce((u,m)=>u+(m.summary?.Total.size.Value??0),0)+l.reduce((u,m)=>u+(m.file_info.size.Value??0),0)),{api:f,repository:c}=S(),h=async()=>{n(!0);const u=await f.downloadSnapshotVFS({repository:c,snapshot:t.identifier.Value,paths:s.map(j=>j.path)}),m=document.createElement("a");m.style.display="none",m.target="_blank",m.href=u.url,document.body.appendChild(m),m.click(),document.body.removeChild(m),n(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(Mt,{numberOfItemsSelected:r.length+l.length}),e.jsx(bt,{text:`${s.length} selected`,altText:o.Pretty,onUnselect:a,children:e.jsx(I,{variant:"primary",onPress:h,isPending:i,leftIcon:"download",children:"Download"})})]})}function Mt({numberOfItemsSelected:t}){const{proceed:s,reset:a,status:i}=xt({shouldBlockFn:({current:n,next:r})=>!(t<2||n.pathname===r.pathname),withResolver:!0,enableBeforeUnload:!1});return e.jsx(V,{isDismissable:!0,isOpen:i==="blocked",onOpenChange:()=>a?.(),"aria-label":"Leaving the page?",children:e.jsxs(V.Dialog,{children:[e.jsx(V.Header,{title:"Leaving the page?",description:e.jsxs(e.Fragment,{children:["You have selected ",e.jsx("strong",{children:t})," files and directories."]})}),e.jsx(V.Content,{children:"If you leave this page, your selection will be lost."}),e.jsxs(V.Footer,{className:"flex flex-wrap justify-end gap-2",children:[e.jsx(I,{variant:"secondary",onPress:()=>a?.(),children:"Stay here"}),e.jsx(I,{variant:"error",onPress:()=>s?.(),children:"Leave the page"})]})]})})}function Ot({vfsEntry:t,href:s}){const a=t.summary?.Total.errors??"several";return e.jsxs(te,{title:"Unable to backup some files in this directory",variant:"error",actions:e.jsx(I,{variant:"secondary",href:s,children:"View Errors"}),children:["Backup completed with ",e.jsxs("strong",{children:[a," errors"]})," in this directory and its subdirectories."]})}function Ut(t){return typeof t=="function"}function ge(t,...s){return Ut(t)?t(...s):t}function At(t){return t||(typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():"")}class Ht extends Qe{constructor(s){super({pluginId:"pacer",debug:s?.debug})}}const Wt=(t,s)=>{Pe.emit(t,s)},Pe=new Ht;function be(){return{canLeadingExecute:!0,executionCount:0,isPending:!1,lastArgs:void 0,status:"idle",maybeExecuteCount:0}}const Qt={enabled:!0,leading:!1,trailing:!0,wait:0};class qt{constructor(s,a){this.fn=s,this.store=new qe(be()),this.setOptions=i=>{this.options={...this.options,...i},this.#s()||this.cancel()},this.#e=i=>{this.store.setState(n=>{const r={...n,...i},{isPending:l}=r;return{...r,status:this.#s()?l?"pending":"idle":"disabled"}}),Wt("Debouncer",this)},this.#s=()=>!!ge(this.options.enabled,this),this.#n=()=>ge(this.options.wait,this),this.maybeExecute=(...i)=>{if(!this.#s())return;this.#e({maybeExecuteCount:this.store.state.maybeExecuteCount+1});let n=!1;this.options.leading&&this.store.state.canLeadingExecute&&(this.#e({canLeadingExecute:!1}),n=!0,this.#i(...i)),this.options.trailing&&this.#e({isPending:!0,lastArgs:i}),this.#t&&clearTimeout(this.#t),this.#t=setTimeout(()=>{this.#e({canLeadingExecute:!0}),this.options.trailing&&!n&&this.#i(...i)},this.#n())},this.#i=(...i)=>{this.#s()&&(this.fn(...i),this.#e({executionCount:this.store.state.executionCount+1,isPending:!1,lastArgs:void 0}),this.options.onExecute?.(i,this))},this.flush=()=>{this.store.state.isPending&&this.store.state.lastArgs&&(this.#a(),this.#i(...this.store.state.lastArgs))},this.#a=()=>{this.#t&&(clearTimeout(this.#t),this.#t=void 0)},this.cancel=()=>{this.#a(),this.#e({canLeadingExecute:!0,isPending:!1})},this.reset=()=>{this.#e(be())},this.key=At(a.key),this.options={...Qt,...a},this.#e(this.options.initialState??{}),Pe.on("d-Debouncer",i=>{i.payload.key===this.key&&(this.#e(i.payload.store.state),this.setOptions(i.payload.options))})}#t;#e;#s;#n;#i;#a}function Gt(t,s,a=()=>({})){const[i]=x.useState(()=>new qt(t,s)),n=Ge(i.store,a);return i.fn=t,i.setOptions(s),x.useEffect(()=>()=>{i.cancel()},[i]),x.useMemo(()=>({...i,state:n}),[i,n])}function Kt({search:t,searchPlaceholder:s,filters:a,onSearch:i}){const[n,r]=x.useState(t);x.useEffect(()=>{r(t)},[t]);const l=Gt(c=>i(c),{wait:300}),o=c=>{const h=c?String(c):"";r(h),l.maybeExecute(h)},f=()=>{r(""),l.cancel(),i("")};return e.jsxs("div",{className:"flex w-full flex-wrap items-center gap-2 md:flex-nowrap",children:[e.jsx("div",{className:"order-1 flex-1",children:e.jsx(Ke,{icon:"magnifying-glass",placeholder:s,className:"w-full sm:max-w-64 sm:flex-1",value:n,onChange:o,"aria-label":"Search by name",suffix:n?e.jsx(Ye,{icon:"close","aria-label":"Clear text",onPress:f,className:"-mr-2"}):void 0})}),a]})}function cs(){const t=W.useParams(),s=W.useSearch(),a=W.useLoaderData(),i=W.useNavigate(),n=we.find(p=>p.id===s.mime),r=a.getSnapshotResponse.item,l=a.getSnapshotPathResponse.item,o=x.useCallback(p=>i({params:{snapshotId:t.snapshotId},search:g=>({...g,path:p,page:0})}),[i,t.snapshotId]),f=x.useCallback((p,g)=>i({search:F=>({...F,page:F.per_page!==g?0:p,per_page:g})}),[i]),c=x.useCallback(p=>{i({params:{snapshotId:p},search:g=>({...g,page:0})})},[i]),h=x.useCallback(p=>{i({params:{snapshotId:t.snapshotId},search:g=>({...g,preview:p}),replace:!0})},[i,t.snapshotId]),u=x.useCallback(p=>i({search:g=>({...g,page:0,filename:p||void 0})}),[i]),m=x.useCallback(p=>{i({search:g=>({...g,mime:p.has("mime")?"":g.mime,page:0})})},[i]),j=x.useCallback(p=>{i({search:g=>({...g,mime:p.mime||"",page:0})})},[i]);return e.jsx(St,{snapshot:r,source:t.source,vfsEntry:l,page:s.page,perPage:s.per_page,filters:{mime:n,filename:s.filename},onPageChange:f,onPathChange:o,onSnapshotChange:c,preview:s.preview,onPreviewChange:h,breadcrumb:e.jsx(pe,{children:ot(r.identifier,t.source,r.sources[t.source].importer.directory)}),fileBreadcrumb:e.jsx(pe,{children:rt(r.identifier,t.source,r.sources[t.source].importer.directory,l.path)}),onSearch:u,onRemoveFilter:m,onApplyFilter:j,errorPageHref:{to:"/snapshots/$snapshotId/$source/errors",params:{snapshotId:t.snapshotId,source:t.source},search:{path:l.path}}},t.snapshotId)}export{cs as component};
